{
  "issue_id": 3719,
  "issue_url": "https://github.com/alibaba/fastjson/issues/3719",
  "title": "`StringIndexOutOfBoundsException` in `JSONPathParser.next`",
  "description": "<p dir=\"auto\">(from <a href=\"https://bugs.chromium.org/p/oss-fuzz/issues/detail?id=32371\" rel=\"nofollow\">https://bugs.chromium.org/p/oss-fuzz/issues/detail?id=32371</a>)</p>\n<p dir=\"auto\">The following reproducer:</p>\n<div class=\"highlight highlight-source-java notranslate position-relative overflow-auto\" dir=\"auto\" data-snippet-clipboard-copy-content=\"import java.util.Base64;\n\nimport com.alibaba.fastjson.JSON;\nimport com.alibaba.fastjson.JSONException;\n\npublic class FastJsonCrash {\n    public static String btoa(String base64) {\n        return new String(Base64.getDecoder().decode(base64));\n    }\n    public static void main(String[] args) {\n        try {\n            JSON.parse(btoa(\"ewogICAgICJzdGFvbnMiOiBbCiAgICAgewogICAgICIkcmVmIjogIi4gICJocmVmIi97VA==\"));\n        } catch (JSONException unused) {\n        }\n    }\n}\"><pre class=\"notranslate\"><span class=\"pl-k\">import</span> <span class=\"pl-s1\">java</span>.<span class=\"pl-s1\">util</span>.<span class=\"pl-s1\">Base64</span>;\n\n<span class=\"pl-k\">import</span> <span class=\"pl-s1\">com</span>.<span class=\"pl-s1\">alibaba</span>.<span class=\"pl-s1\">fastjson</span>.<span class=\"pl-c1\">JSON</span>;\n<span class=\"pl-k\">import</span> <span class=\"pl-s1\">com</span>.<span class=\"pl-s1\">alibaba</span>.<span class=\"pl-s1\">fastjson</span>.<span class=\"pl-s1\">JSONException</span>;\n\n<span class=\"pl-k\">public</span> <span class=\"pl-k\">class</span> <span class=\"pl-smi\">FastJsonCrash</span> {\n    <span class=\"pl-k\">public</span> <span class=\"pl-k\">static</span> <span class=\"pl-smi\">String</span> <span class=\"pl-en\">btoa</span>(<span class=\"pl-smi\">String</span> <span class=\"pl-s1\">base64</span>) {\n        <span class=\"pl-k\">return</span> <span class=\"pl-k\">new</span> <span class=\"pl-smi\">String</span>(<span class=\"pl-smi\">Base64</span>.<span class=\"pl-en\">getDecoder</span>().<span class=\"pl-en\">decode</span>(<span class=\"pl-s1\">base64</span>));\n    }\n    <span class=\"pl-k\">public</span> <span class=\"pl-k\">static</span> <span class=\"pl-smi\">void</span> <span class=\"pl-en\">main</span>(<span class=\"pl-smi\">String</span>[] <span class=\"pl-s1\">args</span>) {\n        <span class=\"pl-k\">try</span> {\n            <span class=\"pl-smi\">JSON</span>.<span class=\"pl-en\">parse</span>(<span class=\"pl-en\">btoa</span>(<span class=\"pl-s\">\"ewogICAgICJzdGFvbnMiOiBbCiAgICAgewogICAgICIkcmVmIjogIi4gICJocmVmIi97VA==\"</span>));\n        } <span class=\"pl-k\">catch</span> (<span class=\"pl-smi\">JSONException</span> <span class=\"pl-s1\">unused</span>) {\n        }\n    }\n}</pre></div>\n<p dir=\"auto\">throws this exception with the current master branch of fastjson:</p>\n<div class=\"snippet-clipboard-content notranslate position-relative overflow-auto\" data-snippet-clipboard-copy-content=\"java.lang.StringIndexOutOfBoundsException: String index out of range: 3\n\tat java.base/java.lang.StringLatin1.charAt(StringLatin1.java:48)\n\tat java.base/java.lang.String.charAt(String.java:709)\n\tat com.alibaba.fastjson.JSONPath$JSONPathParser.next(JSONPath.java:911)\n\tat com.alibaba.fastjson.JSONPath$JSONPathParser.skipWhitespace(JSONPath.java:1038)\n\tat com.alibaba.fastjson.JSONPath$JSONPathParser.readName(JSONPath.java:1904)\n\tat com.alibaba.fastjson.JSONPath$JSONPathParser.readSegement(JSONPath.java:983)\n\tat com.alibaba.fastjson.JSONPath$JSONPathParser.explain(JSONPath.java:1975)\n\tat com.alibaba.fastjson.JSONPath.init(JSONPath.java:87)\n\tat com.alibaba.fastjson.JSONPath.isRef(JSONPath.java:94)\n\tat com.alibaba.fastjson.parser.DefaultJSONParser.parseObject(DefaultJSONParser.java:458)\n\tat com.alibaba.fastjson.parser.DefaultJSONParser.parseArray(DefaultJSONParser.java:1246)\n\tat com.alibaba.fastjson.parser.DefaultJSONParser.parseObject(DefaultJSONParser.java:533)\n\tat com.alibaba.fastjson.parser.DefaultJSONParser.parse(DefaultJSONParser.java:1427)\n\tat com.alibaba.fastjson.parser.DefaultJSONParser.parse(DefaultJSONParser.java:1393)\n\tat com.alibaba.fastjson.JSON.parse(JSON.java:181)\n\tat com.alibaba.fastjson.JSON.parse(JSON.java:191)\n\tat com.alibaba.fastjson.JSON.parse(JSON.java:147)\n\tat FastJsonCrash.main(FastJsonCrash.java:12)\"><pre class=\"notranslate\"><code class=\"notranslate\">java.lang.StringIndexOutOfBoundsException: String index out of range: 3\n\tat java.base/java.lang.StringLatin1.charAt(StringLatin1.java:48)\n\tat java.base/java.lang.String.charAt(String.java:709)\n\tat com.alibaba.fastjson.JSONPath$JSONPathParser.next(JSONPath.java:911)\n\tat com.alibaba.fastjson.JSONPath$JSONPathParser.skipWhitespace(JSONPath.java:1038)\n\tat com.alibaba.fastjson.JSONPath$JSONPathParser.readName(JSONPath.java:1904)\n\tat com.alibaba.fastjson.JSONPath$JSONPathParser.readSegement(JSONPath.java:983)\n\tat com.alibaba.fastjson.JSONPath$JSONPathParser.explain(JSONPath.java:1975)\n\tat com.alibaba.fastjson.JSONPath.init(JSONPath.java:87)\n\tat com.alibaba.fastjson.JSONPath.isRef(JSONPath.java:94)\n\tat com.alibaba.fastjson.parser.DefaultJSONParser.parseObject(DefaultJSONParser.java:458)\n\tat com.alibaba.fastjson.parser.DefaultJSONParser.parseArray(DefaultJSONParser.java:1246)\n\tat com.alibaba.fastjson.parser.DefaultJSONParser.parseObject(DefaultJSONParser.java:533)\n\tat com.alibaba.fastjson.parser.DefaultJSONParser.parse(DefaultJSONParser.java:1427)\n\tat com.alibaba.fastjson.parser.DefaultJSONParser.parse(DefaultJSONParser.java:1393)\n\tat com.alibaba.fastjson.JSON.parse(JSON.java:181)\n\tat com.alibaba.fastjson.JSON.parse(JSON.java:191)\n\tat com.alibaba.fastjson.JSON.parse(JSON.java:147)\n\tat FastJsonCrash.main(FastJsonCrash.java:12)\n</code></pre></div>",
  "description_text": "(from https://bugs.chromium.org/p/oss-fuzz/issues/detail?id=32371)\nThe following reproducer:\nimport java.util.Base64;\n\nimport com.alibaba.fastjson.JSON;\nimport com.alibaba.fastjson.JSONException;\n\npublic class FastJsonCrash {\n    public static String btoa(String base64) {\n        return new String(Base64.getDecoder().decode(base64));\n    }\n    public static void main(String[] args) {\n        try {\n            JSON.parse(btoa(\"ewogICAgICJzdGFvbnMiOiBbCiAgICAgewogICAgICIkcmVmIjogIi4gICJocmVmIi97VA==\"));\n        } catch (JSONException unused) {\n        }\n    }\n}\nthrows this exception with the current master branch of fastjson:\njava.lang.StringIndexOutOfBoundsException: String index out of range: 3\n\tat java.base/java.lang.StringLatin1.charAt(StringLatin1.java:48)\n\tat java.base/java.lang.String.charAt(String.java:709)\n\tat com.alibaba.fastjson.JSONPath$JSONPathParser.next(JSONPath.java:911)\n\tat com.alibaba.fastjson.JSONPath$JSONPathParser.skipWhitespace(JSONPath.java:1038)\n\tat com.alibaba.fastjson.JSONPath$JSONPathParser.readName(JSONPath.java:1904)\n\tat com.alibaba.fastjson.JSONPath$JSONPathParser.readSegement(JSONPath.java:983)\n\tat com.alibaba.fastjson.JSONPath$JSONPathParser.explain(JSONPath.java:1975)\n\tat com.alibaba.fastjson.JSONPath.init(JSONPath.java:87)\n\tat com.alibaba.fastjson.JSONPath.isRef(JSONPath.java:94)\n\tat com.alibaba.fastjson.parser.DefaultJSONParser.parseObject(DefaultJSONParser.java:458)\n\tat com.alibaba.fastjson.parser.DefaultJSONParser.parseArray(DefaultJSONParser.java:1246)\n\tat com.alibaba.fastjson.parser.DefaultJSONParser.parseObject(DefaultJSONParser.java:533)\n\tat com.alibaba.fastjson.parser.DefaultJSONParser.parse(DefaultJSONParser.java:1427)\n\tat com.alibaba.fastjson.parser.DefaultJSONParser.parse(DefaultJSONParser.java:1393)\n\tat com.alibaba.fastjson.JSON.parse(JSON.java:181)\n\tat com.alibaba.fastjson.JSON.parse(JSON.java:191)\n\tat com.alibaba.fastjson.JSON.parse(JSON.java:147)\n\tat FastJsonCrash.main(FastJsonCrash.java:12)\n"
}