{
  "issue_id": 6908,
  "issue_url": "https://github.com/apache/rocketmq/issues/6908",
  "title": "[Bug] The proxy in the cluster mode obtains the wrong address of the broker",
  "description": "<h3 dir=\"auto\">Before Creating the Bug Report</h3>\n<ul class=\"contains-task-list\">\n<li class=\"task-list-item\">\n<p dir=\"auto\"><input type=\"checkbox\" id=\"\" disabled=\"\" class=\"task-list-item-checkbox\" checked=\"\"> I found a bug, not just asking a question, which should be created in <a href=\"https://github.com/apache/rocketmq/discussions\">GitHub Discussions</a>.</p>\n</li>\n<li class=\"task-list-item\">\n<p dir=\"auto\"><input type=\"checkbox\" id=\"\" disabled=\"\" class=\"task-list-item-checkbox\" checked=\"\"> I have searched the <a href=\"https://github.com/apache/rocketmq/issues\">GitHub Issues</a> and <a href=\"https://github.com/apache/rocketmq/discussions\">GitHub Discussions</a>  of this repository and believe that this is not a duplicate.</p>\n</li>\n<li class=\"task-list-item\">\n<p dir=\"auto\"><input type=\"checkbox\" id=\"\" disabled=\"\" class=\"task-list-item-checkbox\" checked=\"\"> I have confirmed that this bug belongs to the current repository, not other repositories of RocketMQ.</p>\n</li>\n</ul>\n<h3 dir=\"auto\">Runtime platform environment</h3>\n<p dir=\"auto\">OS: CentOS 6.9</p>\n<h3 dir=\"auto\">RocketMQ version</h3>\n<p dir=\"auto\">branch: (develop|tag 5.1.1) version: 5.1.1</p>\n<h3 dir=\"auto\">JDK Version</h3>\n<p dir=\"auto\">JDK: 1.8.0_202</p>\n<h3 dir=\"auto\">Describe the Bug</h3>\n<p dir=\"auto\">When I connect to the clustered proxy to consume messages using the remoting protocol, some messages from one broker cannot be consumed.<br>\nAfter debugging, I found that the obtained offset of broker is wrong.<br>\n<a target=\"_blank\" rel=\"noopener noreferrer\" href=\"https://private-user-images.githubusercontent.com/10137071/246015754-c3b88b07-33f5-4365-8ec2-e078b0c5915e.jpg?jwt=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJnaXRodWIuY29tIiwiYXVkIjoicmF3LmdpdGh1YnVzZXJjb250ZW50LmNvbSIsImtleSI6ImtleTUiLCJleHAiOjE3MTIwNTU3NzIsIm5iZiI6MTcxMjA1NTQ3MiwicGF0aCI6Ii8xMDEzNzA3MS8yNDYwMTU3NTQtYzNiODhiMDctMzNmNS00MzY1LThlYzItZTA3OGIwYzU5MTVlLmpwZz9YLUFtei1BbGdvcml0aG09QVdTNC1ITUFDLVNIQTI1NiZYLUFtei1DcmVkZW50aWFsPUFLSUFWQ09EWUxTQTUzUFFLNFpBJTJGMjAyNDA0MDIlMkZ1cy1lYXN0LTElMkZzMyUyRmF3czRfcmVxdWVzdCZYLUFtei1EYXRlPTIwMjQwNDAyVDEwNTc1MlomWC1BbXotRXhwaXJlcz0zMDAmWC1BbXotU2lnbmF0dXJlPWNiYWU5MDJlN2MxOTJkMTJiNTdhMjdiNDZhMDUzODg3MzNjMGJiZTMxODBmYWY4MjkwYjVkMWZjMTkwYzM4MTAmWC1BbXotU2lnbmVkSGVhZGVycz1ob3N0JmFjdG9yX2lkPTAma2V5X2lkPTAmcmVwb19pZD0wIn0.kD_UxYrCXTBMzhW1OsOKOQ6vwJJyN3Nh2Mw__s2serI\"><img src=\"https://private-user-images.githubusercontent.com/10137071/246015754-c3b88b07-33f5-4365-8ec2-e078b0c5915e.jpg?jwt=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJnaXRodWIuY29tIiwiYXVkIjoicmF3LmdpdGh1YnVzZXJjb250ZW50LmNvbSIsImtleSI6ImtleTUiLCJleHAiOjE3MTIwNTU3NzIsIm5iZiI6MTcxMjA1NTQ3MiwicGF0aCI6Ii8xMDEzNzA3MS8yNDYwMTU3NTQtYzNiODhiMDctMzNmNS00MzY1LThlYzItZTA3OGIwYzU5MTVlLmpwZz9YLUFtei1BbGdvcml0aG09QVdTNC1ITUFDLVNIQTI1NiZYLUFtei1DcmVkZW50aWFsPUFLSUFWQ09EWUxTQTUzUFFLNFpBJTJGMjAyNDA0MDIlMkZ1cy1lYXN0LTElMkZzMyUyRmF3czRfcmVxdWVzdCZYLUFtei1EYXRlPTIwMjQwNDAyVDEwNTc1MlomWC1BbXotRXhwaXJlcz0zMDAmWC1BbXotU2lnbmF0dXJlPWNiYWU5MDJlN2MxOTJkMTJiNTdhMjdiNDZhMDUzODg3MzNjMGJiZTMxODBmYWY4MjkwYjVkMWZjMTkwYzM4MTAmWC1BbXotU2lnbmVkSGVhZGVycz1ob3N0JmFjdG9yX2lkPTAma2V5X2lkPTAmcmVwb19pZD0wIn0.kD_UxYrCXTBMzhW1OsOKOQ6vwJJyN3Nh2Mw__s2serI\" alt=\"bug\" style=\"max-width: 100%;\"></a></p>\n<p dir=\"auto\">As shown in the figure above, when <a href=\"https://github.com/apache/rocketmq/blob/develop/proxy/src/main/java/org/apache/rocketmq/proxy/service/route/ClusterTopicRouteService.java#L66\"><code class=\"notranslate\">ClusterTopicRouteService.getBrokerAddr()</code></a> obtains the broker address, the brokerName in the <strong>parameter is broker-a</strong>, but the <strong>obtained address is broker-b</strong>.</p>\n<h3 dir=\"auto\">Steps to Reproduce</h3>\n<ol dir=\"auto\">\n<li>Deploy a new broker-a, start it.</li>\n<li>Create some topics in broker-a for testing, such as message produing and consuming, that is not important.</li>\n<li>When I deploy a new broker, such as broker-b,  I need <strong>copy topics.json from broker-a to broker-b</strong>, then start it.</li>\n<li>Now broker-b\u2018s topics have broker-a and broker-b.</li>\n</ol>\n<p dir=\"auto\">When <a href=\"https://github.com/apache/rocketmq/blob/develop/proxy/src/main/java/org/apache/rocketmq/proxy/service/route/ClusterTopicRouteService.java#L66\"><code class=\"notranslate\">ClusterTopicRouteService.getBrokerAddr()</code></a> obtains the broker address, the code's logic did not consider this situation(Topic <code class=\"notranslate\">broker-a</code> exist in broker-a and broker-b), so got the wrong broker addr.</p>\n<h3 dir=\"auto\">What Did You Expect to See?</h3>\n<p dir=\"auto\">Got the right broker addr.</p>\n<h3 dir=\"auto\">What Did You See Instead?</h3>\n<p dir=\"auto\">Got the wrong broker addr.</p>\n<h3 dir=\"auto\">Additional Context</h3>\n<p dir=\"auto\"><em>No response</em></p>",
  "description_text": "Before Creating the Bug Report\n\n\n I found a bug, not just asking a question, which should be created in GitHub Discussions.\n\n\n I have searched the GitHub Issues and GitHub Discussions  of this repository and believe that this is not a duplicate.\n\n\n I have confirmed that this bug belongs to the current repository, not other repositories of RocketMQ.\n\n\nRuntime platform environment\nOS: CentOS 6.9\nRocketMQ version\nbranch: (develop|tag 5.1.1) version: 5.1.1\nJDK Version\nJDK: 1.8.0_202\nDescribe the Bug\nWhen I connect to the clustered proxy to consume messages using the remoting protocol, some messages from one broker cannot be consumed.\nAfter debugging, I found that the obtained offset of broker is wrong.\n\nAs shown in the figure above, when ClusterTopicRouteService.getBrokerAddr() obtains the broker address, the brokerName in the parameter is broker-a, but the obtained address is broker-b.\nSteps to Reproduce\n\nDeploy a new broker-a, start it.\nCreate some topics in broker-a for testing, such as message produing and consuming, that is not important.\nWhen I deploy a new broker, such as broker-b,  I need copy topics.json from broker-a to broker-b, then start it.\nNow broker-b\u2018s topics have broker-a and broker-b.\n\nWhen ClusterTopicRouteService.getBrokerAddr() obtains the broker address, the code's logic did not consider this situation(Topic broker-a exist in broker-a and broker-b), so got the wrong broker addr.\nWhat Did You Expect to See?\nGot the right broker addr.\nWhat Did You See Instead?\nGot the wrong broker addr.\nAdditional Context\nNo response"
}