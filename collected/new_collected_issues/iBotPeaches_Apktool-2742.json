{
  "issue_id": 2739,
  "issue_url": "https://github.com/iBotPeaches/Apktool/issues/2739",
  "title": "[BUG] temp file not being deleted when building",
  "description": "<h3 dir=\"auto\">Information</h3>\n<ol dir=\"auto\">\n<li><strong>Apktool Version (<code class=\"notranslate\">apktool -version</code>)</strong> - 2.6.0</li>\n<li><strong>Operating System (Mac, Linux, Windows)</strong> - Windows</li>\n<li><strong>APK From? (Playstore, ROM, Other)</strong> - probably not relevant</li>\n</ol>\n<h3 dir=\"auto\">Steps to Reproduce</h3>\n<ol dir=\"auto\">\n<li><code class=\"notranslate\">apktool b -o out extractedFolder</code></li>\n<li>Monitor the %TEMP% folder; during build, two <code class=\"notranslate\">APKTOOL{longnumber}.tmp</code> files are created, and one of the is removed again. The other stays there.</li>\n</ol>\n<p dir=\"auto\">Note that this only occurs when (re-)building, not when decompiling an .apk. After digging a bit in the source, I suspect the following lines in <code class=\"notranslate\">buildManifest()</code> to be the problem:</p>\n<p dir=\"auto\"></p><div class=\"Box Box--condensed my-2\">\n  <div class=\"Box-header f6\">\n    <p class=\"mb-0 text-bold\">\n      <a href=\"https://github.com/iBotPeaches/Apktool/blob/9bdf3855384414d5e1060bfef263bb0e5b07460a/brut.apktool/apktool-lib/src/main/java/brut/androlib/Androlib.java#L548-L549\">Apktool/brut.apktool/apktool-lib/src/main/java/brut/androlib/Androlib.java</a>\n    </p>\n    <p class=\"mb-0 color-fg-muted\">\n        Lines 548 to 549\n      in\n      <a data-pjax=\"true\" class=\"commit-tease-sha Link--inTextBlock\" href=\"/iBotPeaches/Apktool/commit/9bdf3855384414d5e1060bfef263bb0e5b07460a\">9bdf385</a>\n    </p>\n  </div>\n  <div itemprop=\"text\" class=\"Box-body p-0 blob-wrapper blob-wrapper-embedded data\">\n    <table class=\"highlight tab-size mb-0 js-file-line-container\" data-tab-size=\"8\" data-paste-markdown-skip=\"\">\n\n        <tbody><tr class=\"border-0\">\n          <td id=\"L548\" class=\"blob-num border-0 px-3 py-0 color-bg-default\" data-line-number=\"548\"></td>\n          <td id=\"LC548\" class=\"blob-code border-0 px-3 py-0 color-bg-default blob-code-inner js-file-line\"> <span class=\"pl-smi\">File</span> <span class=\"pl-s1\">apkFile</span> = <span class=\"pl-smi\">File</span>.<span class=\"pl-en\">createTempFile</span>(<span class=\"pl-s\">\"APKTOOL\"</span>, <span class=\"pl-c1\">null</span>); </td>\n        </tr>\n\n        <tr class=\"border-0\">\n          <td id=\"L549\" class=\"blob-num border-0 px-3 py-0 color-bg-default\" data-line-number=\"549\"></td>\n          <td id=\"LC549\" class=\"blob-code border-0 px-3 py-0 color-bg-default blob-code-inner js-file-line\"> <span class=\"pl-s1\">apkFile</span>.<span class=\"pl-en\">delete</span>(); </td>\n        </tr>\n    </tbody></table>\n  </div>\n</div>\n<p></p>\n<p dir=\"auto\">Here, the temporary file is being created and then deleted again (I guess to get the temp filename). Then the filename is used in a call to <code class=\"notranslate\">aaptPackage()</code>, but afterwards it isn't deleted.</p>\n<p dir=\"auto\">Note that <code class=\"notranslate\">buildResourcesFull()</code> also creates a temp filename, but deletes the created file again in line 512, and that's the difference to <code class=\"notranslate\">buildManifest()</code>:</p>\n<p dir=\"auto\"></p><div class=\"Box Box--condensed my-2\">\n  <div class=\"Box-header f6\">\n    <p class=\"mb-0 text-bold\">\n      <a href=\"https://github.com/iBotPeaches/Apktool/blob/9bdf3855384414d5e1060bfef263bb0e5b07460a/brut.apktool/apktool-lib/src/main/java/brut/androlib/Androlib.java#L512\">Apktool/brut.apktool/apktool-lib/src/main/java/brut/androlib/Androlib.java</a>\n    </p>\n    <p class=\"mb-0 color-fg-muted\">\n         Line 512\n      in\n      <a data-pjax=\"true\" class=\"commit-tease-sha Link--inTextBlock\" href=\"/iBotPeaches/Apktool/commit/9bdf3855384414d5e1060bfef263bb0e5b07460a\">9bdf385</a>\n    </p>\n  </div>\n  <div itemprop=\"text\" class=\"Box-body p-0 blob-wrapper blob-wrapper-embedded data\">\n    <table class=\"highlight tab-size mb-0 js-file-line-container\" data-tab-size=\"8\" data-paste-markdown-skip=\"\">\n\n        <tbody><tr class=\"border-0\">\n          <td id=\"L512\" class=\"blob-num border-0 px-3 py-0 color-bg-default\" data-line-number=\"512\"></td>\n          <td id=\"LC512\" class=\"blob-code border-0 px-3 py-0 color-bg-default blob-code-inner js-file-line\"> <span class=\"pl-s1\">apkFile</span>.<span class=\"pl-en\">delete</span>(); </td>\n        </tr>\n    </tbody></table>\n  </div>\n</div>\n<p></p>",
  "description_text": "Information\n\nApktool Version (apktool -version) - 2.6.0\nOperating System (Mac, Linux, Windows) - Windows\nAPK From? (Playstore, ROM, Other) - probably not relevant\n\nSteps to Reproduce\n\napktool b -o out extractedFolder\nMonitor the %TEMP% folder; during build, two APKTOOL{longnumber}.tmp files are created, and one of the is removed again. The other stays there.\n\nNote that this only occurs when (re-)building, not when decompiling an .apk. After digging a bit in the source, I suspect the following lines in buildManifest() to be the problem:\n\n\n\nApktool/brut.apktool/apktool-lib/src/main/java/brut/androlib/Androlib.java\n\n\n        Lines 548 to 549\n      in\n      9bdf385\n\n\n\n\n\n\n File apkFile = File.createTempFile(\"APKTOOL\", null); \n\n\n\n apkFile.delete(); \n\n\n\n\n\nHere, the temporary file is being created and then deleted again (I guess to get the temp filename). Then the filename is used in a call to aaptPackage(), but afterwards it isn't deleted.\nNote that buildResourcesFull() also creates a temp filename, but deletes the created file again in line 512, and that's the difference to buildManifest():\n\n\n\nApktool/brut.apktool/apktool-lib/src/main/java/brut/androlib/Androlib.java\n\n\n         Line 512\n      in\n      9bdf385\n\n\n\n\n\n\n apkFile.delete(); \n\n\n\n\n"
}