{
  "issue_id": 2979,
  "issue_url": "https://github.com/mockito/mockito/issues/2979",
  "title": "`@Mock(serializable = true)` no longer works with parameterized types",
  "description": "<p dir=\"auto\">This appears to be a result of <a class=\"issue-link js-issue-link\" data-error-text=\"Failed to load title\" data-id=\"1595352392\" data-permission-text=\"Title is private\" data-url=\"https://github.com/mockito/mockito/issues/2923\" data-hovercard-type=\"pull_request\" data-hovercard-url=\"/mockito/mockito/pull/2923/hovercard\" href=\"https://github.com/mockito/mockito/pull/2923\">#2923</a>, though I've gotten myself a little confused trying to run the Mockito tests, so I haven't 100% confirmed that.</p>\n<p dir=\"auto\">As a demonstration, I edited <code class=\"notranslate\">MocksSerializationForAnnotationTest.java</code> to contain:</p>\n<div class=\"highlight highlight-source-java notranslate position-relative overflow-auto\" dir=\"auto\" data-snippet-clipboard-copy-content=\"@Mock(serializable = true)\nSupplier<Object> parameterizedSupplier;\n\n@Test\npublic void should_allow_mock_of_parameterized_type_to_be_serializable() throws Exception {\n  serializeAndBack(parameterizedSupplier);\n}\"><pre class=\"notranslate\"><span class=\"pl-c1\">@</span><span class=\"pl-c1\">Mock</span>(<span class=\"pl-s1\">serializable</span> = <span class=\"pl-c1\">true</span>)\n<span class=\"pl-smi\">Supplier</span><<span class=\"pl-smi\">Object</span>> <span class=\"pl-s1\">parameterizedSupplier</span>;\n\n<span class=\"pl-c1\">@</span><span class=\"pl-c1\">Test</span>\n<span class=\"pl-k\">public</span> <span class=\"pl-smi\">void</span> <span class=\"pl-s1\">should_allow_mock_of_parameterized_type_to_be_serializable</span>() <span class=\"pl-k\">throws</span> <span class=\"pl-s1\">Exception</span> {\n  <span class=\"pl-en\">serializeAndBack</span>(<span class=\"pl-s1\">parameterizedSupplier</span>);\n}</pre></div>\n<p dir=\"auto\">That fails with:</p>\n<div class=\"snippet-clipboard-content notranslate position-relative overflow-auto\" data-snippet-clipboard-copy-content=\"org.mockitousage.basicapi.MocksSerializationForAnnotationTest > should_allow_mock_of_parameterized_type_to_be_serializable FAILED\n    java.io.NotSerializableException: sun.reflect.generics.reflectiveObjects.ParameterizedTypeImpl\n        at java.base/java.io.ObjectOutputStream.writeObject0(ObjectOutputStream.java:1185)\n        at java.base/java.io.ObjectOutputStream.defaultWriteFields(ObjectOutputStream.java:1553)\n        at java.base/java.io.ObjectOutputStream.writeSerialData(ObjectOutputStream.java:1510)\n        at java.base/java.io.ObjectOutputStream.writeOrdinaryObject(ObjectOutputStream.java:1433)\n        at java.base/java.io.ObjectOutputStream.writeObject0(ObjectOutputStream.java:1179)\n        at java.base/java.io.ObjectOutputStream.defaultWriteFields(ObjectOutputStream.java:1553)\n        at java.base/java.io.ObjectOutputStream.writeSerialData(ObjectOutputStream.java:1510)\n        at java.base/java.io.ObjectOutputStream.writeOrdinaryObject(ObjectOutputStream.java:1433)\n        at java.base/java.io.ObjectOutputStream.writeObject0(ObjectOutputStream.java:1179)\n        at java.base/java.io.ObjectOutputStream.defaultWriteFields(ObjectOutputStream.java:1553)\n        at java.base/java.io.ObjectOutputStream.writeSerialData(ObjectOutputStream.java:1510)\n        at java.base/java.io.ObjectOutputStream.writeOrdinaryObject(ObjectOutputStream.java:1433)\n        at java.base/java.io.ObjectOutputStream.writeObject0(ObjectOutputStream.java:1179)\n        at java.base/java.io.ObjectOutputStream.defaultWriteFields(ObjectOutputStream.java:1553)\n        at java.base/java.io.ObjectOutputStream.writeSerialData(ObjectOutputStream.java:1510)\n        at java.base/java.io.ObjectOutputStream.writeOrdinaryObject(ObjectOutputStream.java:1433)\n        at java.base/java.io.ObjectOutputStream.writeObject0(ObjectOutputStream.java:1179)\n        at java.base/java.io.ObjectOutputStream.defaultWriteFields(ObjectOutputStream.java:1553)\n        at java.base/java.io.ObjectOutputStream.writeSerialData(ObjectOutputStream.java:1510)\n        at java.base/java.io.ObjectOutputStream.writeOrdinaryObject(ObjectOutputStream.java:1433)\n        at java.base/java.io.ObjectOutputStream.writeObject0(ObjectOutputStream.java:1179)\n        at java.base/java.io.ObjectOutputStream.defaultWriteFields(ObjectOutputStream.java:1553)\n        at java.base/java.io.ObjectOutputStream.writeSerialData(ObjectOutputStream.java:1510)\n        at java.base/java.io.ObjectOutputStream.writeOrdinaryObject(ObjectOutputStream.java:1433)\n        at java.base/java.io.ObjectOutputStream.writeObject0(ObjectOutputStream.java:1179)\n        at java.base/java.io.ObjectOutputStream.writeObject(ObjectOutputStream.java:349)\n        at org.mockitoutil.SimpleSerializationUtil.serializeMock(SimpleSerializationUtil.java:40)\n        at org.mockitoutil.SimpleSerializationUtil.serializeAndBack(SimpleSerializationUtil.java:21)\n        at org.mockitousage.basicapi.MocksSerializationForAnnotationTest.should_allow_mock_of_parameterized_type_to_be_serializable(MocksSerializationForAnnotationTest.java:77)\"><pre class=\"notranslate\"><code class=\"notranslate\">org.mockitousage.basicapi.MocksSerializationForAnnotationTest > should_allow_mock_of_parameterized_type_to_be_serializable FAILED\n    java.io.NotSerializableException: sun.reflect.generics.reflectiveObjects.ParameterizedTypeImpl\n        at java.base/java.io.ObjectOutputStream.writeObject0(ObjectOutputStream.java:1185)\n        at java.base/java.io.ObjectOutputStream.defaultWriteFields(ObjectOutputStream.java:1553)\n        at java.base/java.io.ObjectOutputStream.writeSerialData(ObjectOutputStream.java:1510)\n        at java.base/java.io.ObjectOutputStream.writeOrdinaryObject(ObjectOutputStream.java:1433)\n        at java.base/java.io.ObjectOutputStream.writeObject0(ObjectOutputStream.java:1179)\n        at java.base/java.io.ObjectOutputStream.defaultWriteFields(ObjectOutputStream.java:1553)\n        at java.base/java.io.ObjectOutputStream.writeSerialData(ObjectOutputStream.java:1510)\n        at java.base/java.io.ObjectOutputStream.writeOrdinaryObject(ObjectOutputStream.java:1433)\n        at java.base/java.io.ObjectOutputStream.writeObject0(ObjectOutputStream.java:1179)\n        at java.base/java.io.ObjectOutputStream.defaultWriteFields(ObjectOutputStream.java:1553)\n        at java.base/java.io.ObjectOutputStream.writeSerialData(ObjectOutputStream.java:1510)\n        at java.base/java.io.ObjectOutputStream.writeOrdinaryObject(ObjectOutputStream.java:1433)\n        at java.base/java.io.ObjectOutputStream.writeObject0(ObjectOutputStream.java:1179)\n        at java.base/java.io.ObjectOutputStream.defaultWriteFields(ObjectOutputStream.java:1553)\n        at java.base/java.io.ObjectOutputStream.writeSerialData(ObjectOutputStream.java:1510)\n        at java.base/java.io.ObjectOutputStream.writeOrdinaryObject(ObjectOutputStream.java:1433)\n        at java.base/java.io.ObjectOutputStream.writeObject0(ObjectOutputStream.java:1179)\n        at java.base/java.io.ObjectOutputStream.defaultWriteFields(ObjectOutputStream.java:1553)\n        at java.base/java.io.ObjectOutputStream.writeSerialData(ObjectOutputStream.java:1510)\n        at java.base/java.io.ObjectOutputStream.writeOrdinaryObject(ObjectOutputStream.java:1433)\n        at java.base/java.io.ObjectOutputStream.writeObject0(ObjectOutputStream.java:1179)\n        at java.base/java.io.ObjectOutputStream.defaultWriteFields(ObjectOutputStream.java:1553)\n        at java.base/java.io.ObjectOutputStream.writeSerialData(ObjectOutputStream.java:1510)\n        at java.base/java.io.ObjectOutputStream.writeOrdinaryObject(ObjectOutputStream.java:1433)\n        at java.base/java.io.ObjectOutputStream.writeObject0(ObjectOutputStream.java:1179)\n        at java.base/java.io.ObjectOutputStream.writeObject(ObjectOutputStream.java:349)\n        at org.mockitoutil.SimpleSerializationUtil.serializeMock(SimpleSerializationUtil.java:40)\n        at org.mockitoutil.SimpleSerializationUtil.serializeAndBack(SimpleSerializationUtil.java:21)\n        at org.mockitousage.basicapi.MocksSerializationForAnnotationTest.should_allow_mock_of_parameterized_type_to_be_serializable(MocksSerializationForAnnotationTest.java:77)\n</code></pre></div>\n<p dir=\"auto\">I think I'm seeing it fixed if I change <code class=\"notranslate\">CreationSettings.genericTypeToMock</code> to be <code class=\"notranslate\">transient</code>. That <em>might</em> be OK: The motivation for starting to use <code class=\"notranslate\">genericTypeToMock</code> seems to have been for disambiguating between fields for <code class=\"notranslate\">@InjectMocks</code>, so I wouldn't expect it to be needed after deserialization. But maybe <code class=\"notranslate\">genericTypeToMock</code> is used in more advanced ways that <em>would</em> matter after deserialization (say, to figure out what type a <code class=\"notranslate\">Supplier<String></code> should return from its <code class=\"notranslate\">get</code> method in some cases), or maybe the hope is to use it in such ways in the future?</p>\n<p dir=\"auto\">(Alternatively, Mockito could skip setting the generic type for serializable mocks, but that could be surprising. Or Mockito could perform its own custom serialization and deserialization of parameterized types, but that sounds like a lot of work for little payoff.)</p>\n<p dir=\"auto\">In the meantime, we can work around the problem by using <code class=\"notranslate\">Mockito.mock(..., withSettings().serializable())</code> instead of <code class=\"notranslate\">@Mock(serializable = true)</code> (since the former doesn't call <code class=\"notranslate\">genericTypeToMock(...)</code>). But we do have one team that is reporting seeing this in a bunch of tests, so they'd have to shift their habits.</p>\n<p dir=\"auto\"><a class=\"user-mention notranslate\" data-hovercard-type=\"user\" data-hovercard-url=\"/users/jfrantzius/hovercard\" data-octo-click=\"hovercard-link-click\" data-octo-dimensions=\"link_type:self\" href=\"https://github.com/jfrantzius\">@jfrantzius</a> again :)</p>",
  "description_text": "This appears to be a result of #2923, though I've gotten myself a little confused trying to run the Mockito tests, so I haven't 100% confirmed that.\nAs a demonstration, I edited MocksSerializationForAnnotationTest.java to contain:\n@Mock(serializable = true)\nSupplier<Object> parameterizedSupplier;\n\n@Test\npublic void should_allow_mock_of_parameterized_type_to_be_serializable() throws Exception {\n  serializeAndBack(parameterizedSupplier);\n}\nThat fails with:\norg.mockitousage.basicapi.MocksSerializationForAnnotationTest > should_allow_mock_of_parameterized_type_to_be_serializable FAILED\n    java.io.NotSerializableException: sun.reflect.generics.reflectiveObjects.ParameterizedTypeImpl\n        at java.base/java.io.ObjectOutputStream.writeObject0(ObjectOutputStream.java:1185)\n        at java.base/java.io.ObjectOutputStream.defaultWriteFields(ObjectOutputStream.java:1553)\n        at java.base/java.io.ObjectOutputStream.writeSerialData(ObjectOutputStream.java:1510)\n        at java.base/java.io.ObjectOutputStream.writeOrdinaryObject(ObjectOutputStream.java:1433)\n        at java.base/java.io.ObjectOutputStream.writeObject0(ObjectOutputStream.java:1179)\n        at java.base/java.io.ObjectOutputStream.defaultWriteFields(ObjectOutputStream.java:1553)\n        at java.base/java.io.ObjectOutputStream.writeSerialData(ObjectOutputStream.java:1510)\n        at java.base/java.io.ObjectOutputStream.writeOrdinaryObject(ObjectOutputStream.java:1433)\n        at java.base/java.io.ObjectOutputStream.writeObject0(ObjectOutputStream.java:1179)\n        at java.base/java.io.ObjectOutputStream.defaultWriteFields(ObjectOutputStream.java:1553)\n        at java.base/java.io.ObjectOutputStream.writeSerialData(ObjectOutputStream.java:1510)\n        at java.base/java.io.ObjectOutputStream.writeOrdinaryObject(ObjectOutputStream.java:1433)\n        at java.base/java.io.ObjectOutputStream.writeObject0(ObjectOutputStream.java:1179)\n        at java.base/java.io.ObjectOutputStream.defaultWriteFields(ObjectOutputStream.java:1553)\n        at java.base/java.io.ObjectOutputStream.writeSerialData(ObjectOutputStream.java:1510)\n        at java.base/java.io.ObjectOutputStream.writeOrdinaryObject(ObjectOutputStream.java:1433)\n        at java.base/java.io.ObjectOutputStream.writeObject0(ObjectOutputStream.java:1179)\n        at java.base/java.io.ObjectOutputStream.defaultWriteFields(ObjectOutputStream.java:1553)\n        at java.base/java.io.ObjectOutputStream.writeSerialData(ObjectOutputStream.java:1510)\n        at java.base/java.io.ObjectOutputStream.writeOrdinaryObject(ObjectOutputStream.java:1433)\n        at java.base/java.io.ObjectOutputStream.writeObject0(ObjectOutputStream.java:1179)\n        at java.base/java.io.ObjectOutputStream.defaultWriteFields(ObjectOutputStream.java:1553)\n        at java.base/java.io.ObjectOutputStream.writeSerialData(ObjectOutputStream.java:1510)\n        at java.base/java.io.ObjectOutputStream.writeOrdinaryObject(ObjectOutputStream.java:1433)\n        at java.base/java.io.ObjectOutputStream.writeObject0(ObjectOutputStream.java:1179)\n        at java.base/java.io.ObjectOutputStream.writeObject(ObjectOutputStream.java:349)\n        at org.mockitoutil.SimpleSerializationUtil.serializeMock(SimpleSerializationUtil.java:40)\n        at org.mockitoutil.SimpleSerializationUtil.serializeAndBack(SimpleSerializationUtil.java:21)\n        at org.mockitousage.basicapi.MocksSerializationForAnnotationTest.should_allow_mock_of_parameterized_type_to_be_serializable(MocksSerializationForAnnotationTest.java:77)\n\nI think I'm seeing it fixed if I change CreationSettings.genericTypeToMock to be transient. That might be OK: The motivation for starting to use genericTypeToMock seems to have been for disambiguating between fields for @InjectMocks, so I wouldn't expect it to be needed after deserialization. But maybe genericTypeToMock is used in more advanced ways that would matter after deserialization (say, to figure out what type a Supplier should return from its get method in some cases), or maybe the hope is to use it in such ways in the future?\n(Alternatively, Mockito could skip setting the generic type for serializable mocks, but that could be surprising. Or Mockito could perform its own custom serialization and deserialization of parameterized types, but that sounds like a lot of work for little payoff.)\nIn the meantime, we can work around the problem by using Mockito.mock(..., withSettings().serializable()) instead of @Mock(serializable = true) (since the former doesn't call genericTypeToMock(...)). But we do have one team that is reporting seeing this in a bunch of tests, so they'd have to shift their habits.\n@jfrantzius again :)"
}