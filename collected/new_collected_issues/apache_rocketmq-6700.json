{
  "issue_id": 6699,
  "issue_url": "https://github.com/apache/rocketmq/issues/6699",
  "title": "[Enhancement] Make NotificationProcessor use PopLongPollingService",
  "description": "<h3 dir=\"auto\">Before Creating the Enhancement Request</h3>\n<ul class=\"contains-task-list\">\n<li class=\"task-list-item\"><input type=\"checkbox\" id=\"\" disabled=\"\" class=\"task-list-item-checkbox\" checked=\"\"> I have confirmed that this should be classified as an enhancement rather than a bug/feature.</li>\n</ul>\n<h3 dir=\"auto\">Summary</h3>\n<p dir=\"auto\">Make <code class=\"notranslate\">NotificationProcessor</code> use <code class=\"notranslate\">PopLongPollingService</code></p>\n<h3 dir=\"auto\">Motivation</h3>\n<ol dir=\"auto\">\n<li>Use a unified class <code class=\"notranslate\">PopLongPollingService</code> to implement long-polling.</li>\n<li>The original <code class=\"notranslate\">wakeup</code> in  <code class=\"notranslate\">NotificationProcessor</code> will notice all the long-polling requests with same key.</li>\n<li>The <code class=\"notranslate\">polling</code> method in <code class=\"notranslate\">NotificationProcessor</code> has a potential data race condition.</li>\n</ol>\n<p dir=\"auto\"></p><div class=\"Box Box--condensed my-2\">\n  <div class=\"Box-header f6\">\n    <p class=\"mb-0 text-bold\">\n      <a href=\"https://github.com/apache/rocketmq/blob/d9223ffd787099285cb728d176a05795f6f56df6/broker/src/main/java/org/apache/rocketmq/broker/processor/NotificationProcessor.java#L301-L308\">rocketmq/broker/src/main/java/org/apache/rocketmq/broker/processor/NotificationProcessor.java</a>\n    </p>\n    <p class=\"mb-0 color-fg-muted\">\n        Lines 301 to 308\n      in\n      <a data-pjax=\"true\" class=\"commit-tease-sha Link--inTextBlock\" href=\"/apache/rocketmq/commit/d9223ffd787099285cb728d176a05795f6f56df6\">d9223ff</a>\n    </p>\n  </div>\n  <div itemprop=\"text\" class=\"Box-body p-0 blob-wrapper blob-wrapper-embedded data\">\n    <table class=\"highlight tab-size mb-0 js-file-line-container\" data-tab-size=\"8\" data-paste-markdown-skip=\"\">\n\n        <tbody><tr class=\"border-0\">\n          <td id=\"L301\" class=\"blob-num border-0 px-3 py-0 color-bg-default\" data-line-number=\"301\"></td>\n          <td id=\"LC301\" class=\"blob-code border-0 px-3 py-0 color-bg-default blob-code-inner js-file-line\"> <span class=\"pl-smi\">ArrayBlockingQueue</span><<span class=\"pl-smi\">NotificationRequest</span>> <span class=\"pl-s1\">queue</span> = <span class=\"pl-s1\">pollingMap</span>.<span class=\"pl-en\">get</span>(<span class=\"pl-s1\">key</span>); </td>\n        </tr>\n\n        <tr class=\"border-0\">\n          <td id=\"L302\" class=\"blob-num border-0 px-3 py-0 color-bg-default\" data-line-number=\"302\"></td>\n          <td id=\"LC302\" class=\"blob-code border-0 px-3 py-0 color-bg-default blob-code-inner js-file-line\"> <span class=\"pl-k\">if</span> (<span class=\"pl-s1\">queue</span> == <span class=\"pl-c1\">null</span>) { </td>\n        </tr>\n\n        <tr class=\"border-0\">\n          <td id=\"L303\" class=\"blob-num border-0 px-3 py-0 color-bg-default\" data-line-number=\"303\"></td>\n          <td id=\"LC303\" class=\"blob-code border-0 px-3 py-0 color-bg-default blob-code-inner js-file-line\">     <span class=\"pl-s1\">queue</span> = <span class=\"pl-k\">new</span> <span class=\"pl-smi\">ArrayBlockingQueue</span><>(<span class=\"pl-smi\">this</span>.<span class=\"pl-s1\">brokerController</span>.<span class=\"pl-en\">getBrokerConfig</span>().<span class=\"pl-en\">getPopPollingSize</span>()); </td>\n        </tr>\n\n        <tr class=\"border-0\">\n          <td id=\"L304\" class=\"blob-num border-0 px-3 py-0 color-bg-default\" data-line-number=\"304\"></td>\n          <td id=\"LC304\" class=\"blob-code border-0 px-3 py-0 color-bg-default blob-code-inner js-file-line\">     <span class=\"pl-s1\">pollingMap</span>.<span class=\"pl-en\">put</span>(<span class=\"pl-s1\">key</span>, <span class=\"pl-s1\">queue</span>); </td>\n        </tr>\n\n        <tr class=\"border-0\">\n          <td id=\"L305\" class=\"blob-num border-0 px-3 py-0 color-bg-default\" data-line-number=\"305\"></td>\n          <td id=\"LC305\" class=\"blob-code border-0 px-3 py-0 color-bg-default blob-code-inner js-file-line\">     <span class=\"pl-s1\">result</span> = <span class=\"pl-s1\">queue</span>.<span class=\"pl-en\">offer</span>(<span class=\"pl-s1\">request</span>); </td>\n        </tr>\n\n        <tr class=\"border-0\">\n          <td id=\"L306\" class=\"blob-num border-0 px-3 py-0 color-bg-default\" data-line-number=\"306\"></td>\n          <td id=\"LC306\" class=\"blob-code border-0 px-3 py-0 color-bg-default blob-code-inner js-file-line\"> } <span class=\"pl-k\">else</span> { </td>\n        </tr>\n\n        <tr class=\"border-0\">\n          <td id=\"L307\" class=\"blob-num border-0 px-3 py-0 color-bg-default\" data-line-number=\"307\"></td>\n          <td id=\"LC307\" class=\"blob-code border-0 px-3 py-0 color-bg-default blob-code-inner js-file-line\">     <span class=\"pl-s1\">result</span> = <span class=\"pl-s1\">queue</span>.<span class=\"pl-en\">offer</span>(<span class=\"pl-s1\">request</span>); </td>\n        </tr>\n\n        <tr class=\"border-0\">\n          <td id=\"L308\" class=\"blob-num border-0 px-3 py-0 color-bg-default\" data-line-number=\"308\"></td>\n          <td id=\"LC308\" class=\"blob-code border-0 px-3 py-0 color-bg-default blob-code-inner js-file-line\"> } </td>\n        </tr>\n    </tbody></table>\n  </div>\n</div>\n<p></p>\n<h3 dir=\"auto\">Describe the Solution You'd Like</h3>\n<ol dir=\"auto\">\n<li>Move long-polling related code from <code class=\"notranslate\">PopMessageProcessor</code> into <code class=\"notranslate\">PopLongPollingService</code> like <code class=\"notranslate\">wakeup()</code></li>\n<li>Use <code class=\"notranslate\">PollingResult</code> enum to replace int value</li>\n<li><code class=\"notranslate\">NotificationProcessor</code> use <code class=\"notranslate\">PopLongPollingService</code> to implement long-polling.</li>\n</ol>\n<h3 dir=\"auto\">Describe Alternatives You've Considered</h3>\n<p dir=\"auto\">No</p>\n<h3 dir=\"auto\">Additional Context</h3>\n<p dir=\"auto\"><em>No response</em></p>",
  "description_text": "Before Creating the Enhancement Request\n\n I have confirmed that this should be classified as an enhancement rather than a bug/feature.\n\nSummary\nMake NotificationProcessor use PopLongPollingService\nMotivation\n\nUse a unified class PopLongPollingService to implement long-polling.\nThe original wakeup in  NotificationProcessor will notice all the long-polling requests with same key.\nThe polling method in NotificationProcessor has a potential data race condition.\n\n\n\n\nrocketmq/broker/src/main/java/org/apache/rocketmq/broker/processor/NotificationProcessor.java\n\n\n        Lines 301 to 308\n      in\n      d9223ff\n\n\n\n\n\n\n ArrayBlockingQueue<NotificationRequest> queue = pollingMap.get(key); \n\n\n\n if (queue == null) { \n\n\n\n queue = new ArrayBlockingQueue<>(this.brokerController.getBrokerConfig().getPopPollingSize()); \n\n\n\n pollingMap.put(key, queue); \n\n\n\n result = queue.offer(request); \n\n\n\n } else { \n\n\n\n result = queue.offer(request); \n\n\n\n } \n\n\n\n\n\nDescribe the Solution You'd Like\n\nMove long-polling related code from PopMessageProcessor into PopLongPollingService like wakeup()\nUse PollingResult enum to replace int value\nNotificationProcessor use PopLongPollingService to implement long-polling.\n\nDescribe Alternatives You've Considered\nNo\nAdditional Context\nNo response"
}