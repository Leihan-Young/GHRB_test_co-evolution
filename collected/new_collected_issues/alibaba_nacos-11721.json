{
  "issue_id": 11422,
  "issue_url": "https://github.com/alibaba/nacos/issues/11422",
  "title": "When nacos use enhancement such as opentelemetry javaagent or skywalking javaagent,etc, the server cannot connect to the client",
  "description": "<p dir=\"auto\"><strong>Describe the bug</strong><br>\nWhen nacos use enhancement such as opentelemetry javaagent or skywalking javaagent,etc, the server cannot connect to the client.<br>\nIn the getInternalChannel method of GrpcConnectionInterceptor.java, serverCall is usually enhanced to ForwardingServerCall.SimpleForwardingServerCall, then ServerStreamHelper.getServerStream (serverCall), serverCall will not instanceof ServerCallImpl<br>\n<a href=\"https://github.com/apache/skywalking-java/blob/main/apm-sniffer/apm-sdk-plugin/grpc-1.x-plugin/src/main/java/org/apache/skywalking/apm/plugin/grpc/v1/server/ServerInterceptor.java#L68\">skywalking</a><br>\n<a href=\"https://github.com/open-telemetry/opentelemetry-java-instrumentation/blob/main/instrumentation/grpc-1.6/library/src/main/java/io/opentelemetry/instrumentation/grpc/v1_6/TracingServerInterceptor.java#L59\">opentelemetry</a><br>\n<a target=\"_blank\" rel=\"noopener noreferrer\" href=\"https://private-user-images.githubusercontent.com/88769332/285228874-f7274a84-ab48-4ba1-896f-a0c8eda7d8bf.png?jwt=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJnaXRodWIuY29tIiwiYXVkIjoicmF3LmdpdGh1YnVzZXJjb250ZW50LmNvbSIsImtleSI6ImtleTUiLCJleHAiOjE3MTIwODY2NzAsIm5iZiI6MTcxMjA4NjM3MCwicGF0aCI6Ii84ODc2OTMzMi8yODUyMjg4NzQtZjcyNzRhODQtYWI0OC00YmExLTg5NmYtYTBjOGVkYTdkOGJmLnBuZz9YLUFtei1BbGdvcml0aG09QVdTNC1ITUFDLVNIQTI1NiZYLUFtei1DcmVkZW50aWFsPUFLSUFWQ09EWUxTQTUzUFFLNFpBJTJGMjAyNDA0MDIlMkZ1cy1lYXN0LTElMkZzMyUyRmF3czRfcmVxdWVzdCZYLUFtei1EYXRlPTIwMjQwNDAyVDE5MzI1MFomWC1BbXotRXhwaXJlcz0zMDAmWC1BbXotU2lnbmF0dXJlPTJjNmM2OTI0NWM5NWNjNzIzMTFjNDBiNWViMmU0OTMxYjgzZDIxNzY0NGFkZjZiZTNmMzg1ZmI4Y2JhYzkwN2YmWC1BbXotU2lnbmVkSGVhZGVycz1ob3N0JmFjdG9yX2lkPTAma2V5X2lkPTAmcmVwb19pZD0wIn0.iMDMtPDShQONrbYorvnbieVe7U_HDPw1NeAfdWVr9OY\"><img src=\"https://private-user-images.githubusercontent.com/88769332/285228874-f7274a84-ab48-4ba1-896f-a0c8eda7d8bf.png?jwt=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJnaXRodWIuY29tIiwiYXVkIjoicmF3LmdpdGh1YnVzZXJjb250ZW50LmNvbSIsImtleSI6ImtleTUiLCJleHAiOjE3MTIwODY2NzAsIm5iZiI6MTcxMjA4NjM3MCwicGF0aCI6Ii84ODc2OTMzMi8yODUyMjg4NzQtZjcyNzRhODQtYWI0OC00YmExLTg5NmYtYTBjOGVkYTdkOGJmLnBuZz9YLUFtei1BbGdvcml0aG09QVdTNC1ITUFDLVNIQTI1NiZYLUFtei1DcmVkZW50aWFsPUFLSUFWQ09EWUxTQTUzUFFLNFpBJTJGMjAyNDA0MDIlMkZ1cy1lYXN0LTElMkZzMyUyRmF3czRfcmVxdWVzdCZYLUFtei1EYXRlPTIwMjQwNDAyVDE5MzI1MFomWC1BbXotRXhwaXJlcz0zMDAmWC1BbXotU2lnbmF0dXJlPTJjNmM2OTI0NWM5NWNjNzIzMTFjNDBiNWViMmU0OTMxYjgzZDIxNzY0NGFkZjZiZTNmMzg1ZmI4Y2JhYzkwN2YmWC1BbXotU2lnbmVkSGVhZGVycz1ob3N0JmFjdG9yX2lkPTAma2V5X2lkPTAmcmVwb19pZD0wIn0.iMDMtPDShQONrbYorvnbieVe7U_HDPw1NeAfdWVr9OY\" alt=\"image\" style=\"max-width: 100%;\"></a></p>\n<p dir=\"auto\"><strong>Expected behavior</strong><br>\nConnect the server and client normally<br>\n<strong>Actually behavior</strong><br>\nthe server cannot connect to the client.</p>\n<p dir=\"auto\"><strong>How to Reproduce</strong><br>\nVM options set opentelemetry javaagent</p>\n<p dir=\"auto\"><strong>How to Resolve</strong><br>\ndetermine ForwardingServerCall.SimpleForwardingServerCall type in GrpcConnectionInterceptor.java and convert to ServerCallImpl or turn off the grpc enhancement of the javaagent</p>",
  "description_text": "Describe the bug\nWhen nacos use enhancement such as opentelemetry javaagent or skywalking javaagent,etc, the server cannot connect to the client.\nIn the getInternalChannel method of GrpcConnectionInterceptor.java, serverCall is usually enhanced to ForwardingServerCall.SimpleForwardingServerCall, then ServerStreamHelper.getServerStream (serverCall), serverCall will not instanceof ServerCallImpl\nskywalking\nopentelemetry\n\nExpected behavior\nConnect the server and client normally\nActually behavior\nthe server cannot connect to the client.\nHow to Reproduce\nVM options set opentelemetry javaagent\nHow to Resolve\ndetermine ForwardingServerCall.SimpleForwardingServerCall type in GrpcConnectionInterceptor.java and convert to ServerCallImpl or turn off the grpc enhancement of the javaagent"
}