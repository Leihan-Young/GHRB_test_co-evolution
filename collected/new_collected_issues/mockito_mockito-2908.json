{
  "issue_id": 2905,
  "issue_url": "https://github.com/mockito/mockito/issues/2905",
  "title": "StackOverflow while mocking a ThreadLocal on Mockito 5.1.1",
  "description": "<p dir=\"auto\">Hello Folks,</p>\n<p dir=\"auto\">I'm upgrading Mockito in a Java application from 4.9.0 to 5.1.1. We are on JDK 11 (I personally use Temurin 11.0.13).</p>\n<p dir=\"auto\">So, I've a test failing due to a StackOverflow</p>\n<div class=\"snippet-clipboard-content notranslate position-relative overflow-auto\" data-snippet-clipboard-copy-content=\"java.lang.StackOverflowError\n\tat org.mockito.internal.creation.bytebuddy.inject.MockMethodDispatcher.get(MockMethodDispatcher.java:34)\n\tat java.base/java.lang.ThreadLocal.get(ThreadLocal.java:162)\n\tat org.mockito.internal.creation.bytebuddy.MockMethodAdvice$SelfCallInfo.checkSelfCall(MockMethodAdvice.java:368)\n\tat org.mockito.internal.creation.bytebuddy.MockMethodAdvice.isMocked(MockMethodAdvice.java:171)\"><pre class=\"notranslate\"><code class=\"notranslate\">java.lang.StackOverflowError\n\tat org.mockito.internal.creation.bytebuddy.inject.MockMethodDispatcher.get(MockMethodDispatcher.java:34)\n\tat java.base/java.lang.ThreadLocal.get(ThreadLocal.java:162)\n\tat org.mockito.internal.creation.bytebuddy.MockMethodAdvice$SelfCallInfo.checkSelfCall(MockMethodAdvice.java:368)\n\tat org.mockito.internal.creation.bytebuddy.MockMethodAdvice.isMocked(MockMethodAdvice.java:171)\n</code></pre></div>\n<p dir=\"auto\">This happens when we mock a class that extends <code class=\"notranslate\">ThreadLocal</code>. But I verified that it happens also by mocking <code class=\"notranslate\">ThreadLocal</code> as well.</p>\n<p dir=\"auto\">Sounds like a bug, but you are the experts here.</p>\n<p dir=\"auto\">Best regards,<br>\nRoberto</p>",
  "description_text": "Hello Folks,\nI'm upgrading Mockito in a Java application from 4.9.0 to 5.1.1. We are on JDK 11 (I personally use Temurin 11.0.13).\nSo, I've a test failing due to a StackOverflow\njava.lang.StackOverflowError\n\tat org.mockito.internal.creation.bytebuddy.inject.MockMethodDispatcher.get(MockMethodDispatcher.java:34)\n\tat java.base/java.lang.ThreadLocal.get(ThreadLocal.java:162)\n\tat org.mockito.internal.creation.bytebuddy.MockMethodAdvice$SelfCallInfo.checkSelfCall(MockMethodAdvice.java:368)\n\tat org.mockito.internal.creation.bytebuddy.MockMethodAdvice.isMocked(MockMethodAdvice.java:171)\n\nThis happens when we mock a class that extends ThreadLocal. But I verified that it happens also by mocking ThreadLocal as well.\nSounds like a bug, but you are the experts here.\nBest regards,\nRoberto"
}