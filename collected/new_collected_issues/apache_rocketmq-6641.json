{
  "issue_id": 6570,
  "issue_url": "https://github.com/apache/rocketmq/issues/6570",
  "title": "expectLogicOffset is greater than currentLogicOffset in consumeQueue build when the message is illegal",
  "description": "<p dir=\"auto\">The issue tracker is used for bug reporting purposes <strong>ONLY</strong> whereas feature request needs to follow the <a href=\"https://github.com/apache/rocketmq/wiki/RocketMQ-Improvement-Proposal\">RIP process</a>. To avoid unnecessary duplication, please check whether there is a previous issue before filing a new one.</p>\n<p dir=\"auto\">It is recommended to start a discussion thread in the <a href=\"http://rocketmq.apache.org/about/contact/\" rel=\"nofollow\">mailing lists</a> or <a href=\"https://github.com/apache/rocketmq/discussions\">github discussions</a> in cases of discussing your deployment plan, API clarification, and other non-bug-reporting issues.<br>\nWe welcome any friendly suggestions, bug fixes, collaboration, and other improvements.</p>\n<p dir=\"auto\">Please ensure that your bug report is clear and self-contained. Otherwise, it would take additional rounds of communication, thus more time, to understand the problem itself.</p>\n<p dir=\"auto\">Generally, fixing an issue goes through the following steps:</p>\n<ol dir=\"auto\">\n<li>Understand the issue reported;</li>\n<li>Reproduce the unexpected behavior locally;</li>\n<li>Perform root cause analysis to identify the underlying problem;</li>\n<li>Create test cases to cover the identified problem;</li>\n<li>Work out a solution to rectify the behavior and make the newly created test cases pass;</li>\n<li>Make a pull request and go through peer review;</li>\n</ol>\n<p dir=\"auto\">As a result, it would be very helpful yet challenging if you could provide an isolated project reproducing your reported issue. Anyway, please ensure your issue report is informative enough for the community to pick up. At a minimum, include the following hints:</p>\n<p dir=\"auto\"><strong>BUG REPORT</strong></p>\n<ol dir=\"auto\">\n<li>Please describe the issue you observed:</li>\n</ol>\n<p dir=\"auto\">After running the 5.1.0 cluster for a while, there were cases where the consume queue offset were misplaced, and the error log frequently appeared in the storeerror.log.</p>\n<p dir=\"auto\"><a target=\"_blank\" rel=\"noopener noreferrer nofollow\" href=\"https://user-images.githubusercontent.com/21963954/231098266-d824f1dc-7ae1-48af-ae29-4c9bbbd31d25.png\"><img src=\"https://user-images.githubusercontent.com/21963954/231098266-d824f1dc-7ae1-48af-ae29-4c9bbbd31d25.png\" alt=\"image\" style=\"max-width: 100%;\"></a></p>\n<p dir=\"auto\">expectLogicOffset is greater than currentLogicOffset, which means that the queueOffset in the topicQueueTable in memory is greater than the actual offset of the ConsumeQueue file.</p>\n<p dir=\"auto\"><a target=\"_blank\" rel=\"noopener noreferrer nofollow\" href=\"https://user-images.githubusercontent.com/21963954/231098671-f9dc14f4-3ea9-4f7f-94bb-9629b4ae87fd.png\"><img src=\"https://user-images.githubusercontent.com/21963954/231098671-f9dc14f4-3ea9-4f7f-94bb-9629b4ae87fd.png\" alt=\"image\" style=\"max-width: 100%;\"></a></p>\n<ol start=\"2\" dir=\"auto\">\n<li>Cause analysis</li>\n</ol>\n<p dir=\"auto\">In the store.log, it was found that there were message's properties \u200b\u200bthat were too long, exceeding the maximum value of short.</p>\n<p dir=\"auto\">When message put to commitlog, the offset in the topicQueueTable will be increased first, and then the message will be encoded.</p>\n<p dir=\"auto\"><a target=\"_blank\" rel=\"noopener noreferrer nofollow\" href=\"https://user-images.githubusercontent.com/21963954/231099405-ec9f8d50-460f-4d30-9764-862e698c5863.png\"><img src=\"https://user-images.githubusercontent.com/21963954/231099405-ec9f8d50-460f-4d30-9764-862e698c5863.png\" alt=\"image\" style=\"max-width: 100%;\"></a></p>\n<p dir=\"auto\"><a target=\"_blank\" rel=\"noopener noreferrer nofollow\" href=\"https://user-images.githubusercontent.com/21963954/231099444-95bb5333-efd7-4b54-9701-5cc0d22e3f68.png\"><img src=\"https://user-images.githubusercontent.com/21963954/231099444-95bb5333-efd7-4b54-9701-5cc0d22e3f68.png\" alt=\"image\" style=\"max-width: 100%;\"></a></p>\n<p dir=\"auto\">The encode process will verify the length of the propertites. If the verification fails, the message will not be written to the commit log, but the offset in the topicQueueTable has already been increased, resulting in the above phenomenon (the queueOffset in the topicQueueTable in memory is greater than the actual offset in the cq file).</p>\n<p dir=\"auto\"><a target=\"_blank\" rel=\"noopener noreferrer nofollow\" href=\"https://user-images.githubusercontent.com/21963954/231099788-4a37116d-9f97-4b15-bc08-e86180fa102d.png\"><img src=\"https://user-images.githubusercontent.com/21963954/231099788-4a37116d-9f97-4b15-bc08-e86180fa102d.png\" alt=\"image\" style=\"max-width: 100%;\"></a></p>",
  "description_text": "The issue tracker is used for bug reporting purposes ONLY whereas feature request needs to follow the RIP process. To avoid unnecessary duplication, please check whether there is a previous issue before filing a new one.\nIt is recommended to start a discussion thread in the mailing lists or github discussions in cases of discussing your deployment plan, API clarification, and other non-bug-reporting issues.\nWe welcome any friendly suggestions, bug fixes, collaboration, and other improvements.\nPlease ensure that your bug report is clear and self-contained. Otherwise, it would take additional rounds of communication, thus more time, to understand the problem itself.\nGenerally, fixing an issue goes through the following steps:\n\nUnderstand the issue reported;\nReproduce the unexpected behavior locally;\nPerform root cause analysis to identify the underlying problem;\nCreate test cases to cover the identified problem;\nWork out a solution to rectify the behavior and make the newly created test cases pass;\nMake a pull request and go through peer review;\n\nAs a result, it would be very helpful yet challenging if you could provide an isolated project reproducing your reported issue. Anyway, please ensure your issue report is informative enough for the community to pick up. At a minimum, include the following hints:\nBUG REPORT\n\nPlease describe the issue you observed:\n\nAfter running the 5.1.0 cluster for a while, there were cases where the consume queue offset were misplaced, and the error log frequently appeared in the storeerror.log.\n\nexpectLogicOffset is greater than currentLogicOffset, which means that the queueOffset in the topicQueueTable in memory is greater than the actual offset of the ConsumeQueue file.\n\n\nCause analysis\n\nIn the store.log, it was found that there were message's properties \u200b\u200bthat were too long, exceeding the maximum value of short.\nWhen message put to commitlog, the offset in the topicQueueTable will be increased first, and then the message will be encoded.\n\n\nThe encode process will verify the length of the propertites. If the verification fails, the message will not be written to the commit log, but the offset in the topicQueueTable has already been increased, resulting in the above phenomenon (the queueOffset in the topicQueueTable in memory is greater than the actual offset in the cq file).\n"
}