{
  "issue_id": 7381,
  "issue_url": "https://github.com/apache/rocketmq/issues/7381",
  "title": "[Bug] The metrics of timerMessage are inaccurate and may even be negative.",
  "description": "<h3 dir=\"auto\">Before Creating the Bug Report</h3>\n<ul class=\"contains-task-list\">\n<li class=\"task-list-item\">\n<p dir=\"auto\"><input type=\"checkbox\" id=\"\" disabled=\"\" class=\"task-list-item-checkbox\" checked=\"\"> I found a bug, not just asking a question, which should be created in <a href=\"https://github.com/apache/rocketmq/discussions\">GitHub Discussions</a>.</p>\n</li>\n<li class=\"task-list-item\">\n<p dir=\"auto\"><input type=\"checkbox\" id=\"\" disabled=\"\" class=\"task-list-item-checkbox\" checked=\"\"> I have searched the <a href=\"https://github.com/apache/rocketmq/issues\">GitHub Issues</a> and <a href=\"https://github.com/apache/rocketmq/discussions\">GitHub Discussions</a>  of this repository and believe that this is not a duplicate.</p>\n</li>\n<li class=\"task-list-item\">\n<p dir=\"auto\"><input type=\"checkbox\" id=\"\" disabled=\"\" class=\"task-list-item-checkbox\" checked=\"\"> I have confirmed that this bug belongs to the current repository, not other repositories of RocketMQ.</p>\n</li>\n</ul>\n<h3 dir=\"auto\">Runtime platform environment</h3>\n<p dir=\"auto\">macos</p>\n<h3 dir=\"auto\">RocketMQ version</h3>\n<p dir=\"auto\">5.1.3</p>\n<h3 dir=\"auto\">JDK Version</h3>\n<p dir=\"auto\"><em>No response</em></p>\n<h3 dir=\"auto\">Describe the Bug</h3>\n<p dir=\"auto\">After the timer message is enqueueed, if the entry time wheel is slow, it will be directly thrown into the dequePutQueue, and the increment operation of metrics will not be performed.<br>\nThis will cause the metrics of timerMessage to be inaccurate and may even be negative.</p>\n<h3 dir=\"auto\">Steps to Reproduce</h3>\n<p dir=\"auto\">just start a local broker, and send timerMessage into it.<br>\nyou need to set the deliver time now + 3~5ms.</p>\n<h3 dir=\"auto\">What Did You Expect to See?</h3>\n<p dir=\"auto\">metrics should be the num of timer messages in the timing wheel.</p>\n<h3 dir=\"auto\">What Did You See Instead?</h3>\n<p dir=\"auto\"><a target=\"_blank\" rel=\"noopener noreferrer\" href=\"https://private-user-images.githubusercontent.com/21073949/269811908-1231e747-686d-4ca8-a7d0-30e9c1213cd2.png?jwt=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJnaXRodWIuY29tIiwiYXVkIjoicmF3LmdpdGh1YnVzZXJjb250ZW50LmNvbSIsImtleSI6ImtleTUiLCJleHAiOjE3MTIwNTYxNjAsIm5iZiI6MTcxMjA1NTg2MCwicGF0aCI6Ii8yMTA3Mzk0OS8yNjk4MTE5MDgtMTIzMWU3NDctNjg2ZC00Y2E4LWE3ZDAtMzBlOWMxMjEzY2QyLnBuZz9YLUFtei1BbGdvcml0aG09QVdTNC1ITUFDLVNIQTI1NiZYLUFtei1DcmVkZW50aWFsPUFLSUFWQ09EWUxTQTUzUFFLNFpBJTJGMjAyNDA0MDIlMkZ1cy1lYXN0LTElMkZzMyUyRmF3czRfcmVxdWVzdCZYLUFtei1EYXRlPTIwMjQwNDAyVDExMDQyMFomWC1BbXotRXhwaXJlcz0zMDAmWC1BbXotU2lnbmF0dXJlPWJlOWFiNDM0MDBlNjhhYTkyY2M0MTIyZWUzNDRmYTg2YmRiMGExZmQxMDBiMzQ0ZGFhNGIwODllMGVmYTQzZDUmWC1BbXotU2lnbmVkSGVhZGVycz1ob3N0JmFjdG9yX2lkPTAma2V5X2lkPTAmcmVwb19pZD0wIn0.iABFQHu0yisYkkdGtdAbTo2QKgW8Mr1q-ii9UV4rT5g\"><img src=\"https://private-user-images.githubusercontent.com/21073949/269811908-1231e747-686d-4ca8-a7d0-30e9c1213cd2.png?jwt=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJnaXRodWIuY29tIiwiYXVkIjoicmF3LmdpdGh1YnVzZXJjb250ZW50LmNvbSIsImtleSI6ImtleTUiLCJleHAiOjE3MTIwNTYxNjAsIm5iZiI6MTcxMjA1NTg2MCwicGF0aCI6Ii8yMTA3Mzk0OS8yNjk4MTE5MDgtMTIzMWU3NDctNjg2ZC00Y2E4LWE3ZDAtMzBlOWMxMjEzY2QyLnBuZz9YLUFtei1BbGdvcml0aG09QVdTNC1ITUFDLVNIQTI1NiZYLUFtei1DcmVkZW50aWFsPUFLSUFWQ09EWUxTQTUzUFFLNFpBJTJGMjAyNDA0MDIlMkZ1cy1lYXN0LTElMkZzMyUyRmF3czRfcmVxdWVzdCZYLUFtei1EYXRlPTIwMjQwNDAyVDExMDQyMFomWC1BbXotRXhwaXJlcz0zMDAmWC1BbXotU2lnbmF0dXJlPWJlOWFiNDM0MDBlNjhhYTkyY2M0MTIyZWUzNDRmYTg2YmRiMGExZmQxMDBiMzQ0ZGFhNGIwODllMGVmYTQzZDUmWC1BbXotU2lnbmVkSGVhZGVycz1ob3N0JmFjdG9yX2lkPTAma2V5X2lkPTAmcmVwb19pZD0wIn0.iABFQHu0yisYkkdGtdAbTo2QKgW8Mr1q-ii9UV4rT5g\" alt=\"image\" style=\"max-width: 100%;\"></a></p>\n<h3 dir=\"auto\">Additional Context</h3>\n<p dir=\"auto\"><em>No response</em></p>",
  "description_text": "Before Creating the Bug Report\n\n\n I found a bug, not just asking a question, which should be created in GitHub Discussions.\n\n\n I have searched the GitHub Issues and GitHub Discussions  of this repository and believe that this is not a duplicate.\n\n\n I have confirmed that this bug belongs to the current repository, not other repositories of RocketMQ.\n\n\nRuntime platform environment\nmacos\nRocketMQ version\n5.1.3\nJDK Version\nNo response\nDescribe the Bug\nAfter the timer message is enqueueed, if the entry time wheel is slow, it will be directly thrown into the dequePutQueue, and the increment operation of metrics will not be performed.\nThis will cause the metrics of timerMessage to be inaccurate and may even be negative.\nSteps to Reproduce\njust start a local broker, and send timerMessage into it.\nyou need to set the deliver time now + 3~5ms.\nWhat Did You Expect to See?\nmetrics should be the num of timer messages in the timing wheel.\nWhat Did You See Instead?\n\nAdditional Context\nNo response"
}