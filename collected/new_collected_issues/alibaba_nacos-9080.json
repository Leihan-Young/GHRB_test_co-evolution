{
  "issue_id": 9079,
  "issue_url": "https://github.com/alibaba/nacos/issues/9079",
  "title": "Bug about health check retry times.",
  "description": "<p dir=\"auto\"></p><div class=\"Box Box--condensed my-2\">\n  <div class=\"Box-header f6\">\n    <p class=\"mb-0 text-bold\">\n      <a href=\"https://github.com/alibaba/nacos/blob/0aa695e0d3ae5209f015bf9fd23ea7f06632c002/common/src/main/java/com/alibaba/nacos/common/remote/client/RpcClient.java#L466-L483\">nacos/common/src/main/java/com/alibaba/nacos/common/remote/client/RpcClient.java</a>\n    </p>\n    <p class=\"mb-0 color-fg-muted\">\n        Lines 466 to 483\n      in\n      <a data-pjax=\"true\" class=\"commit-tease-sha Link--inTextBlock\" href=\"/alibaba/nacos/commit/0aa695e0d3ae5209f015bf9fd23ea7f06632c002\">0aa695e</a>\n    </p>\n  </div>\n  <div itemprop=\"text\" class=\"Box-body p-0 blob-wrapper blob-wrapper-embedded data\">\n    <table class=\"highlight tab-size mb-0 js-file-line-container\" data-tab-size=\"8\" data-paste-markdown-skip=\"\">\n\n        <tbody><tr class=\"border-0\">\n          <td id=\"L466\" class=\"blob-num border-0 px-3 py-0 color-bg-default\" data-line-number=\"466\"></td>\n          <td id=\"LC466\" class=\"blob-code border-0 px-3 py-0 color-bg-default blob-code-inner js-file-line\"> <span class=\"pl-k\">private</span> <span class=\"pl-smi\">boolean</span> <span class=\"pl-en\">healthCheck</span>() { </td>\n        </tr>\n\n        <tr class=\"border-0\">\n          <td id=\"L467\" class=\"blob-num border-0 px-3 py-0 color-bg-default\" data-line-number=\"467\"></td>\n          <td id=\"LC467\" class=\"blob-code border-0 px-3 py-0 color-bg-default blob-code-inner js-file-line\">     <span class=\"pl-smi\">HealthCheckRequest</span> <span class=\"pl-s1\">healthCheckRequest</span> = <span class=\"pl-k\">new</span> <span class=\"pl-smi\">HealthCheckRequest</span>(); </td>\n        </tr>\n\n        <tr class=\"border-0\">\n          <td id=\"L468\" class=\"blob-num border-0 px-3 py-0 color-bg-default\" data-line-number=\"468\"></td>\n          <td id=\"LC468\" class=\"blob-code border-0 px-3 py-0 color-bg-default blob-code-inner js-file-line\">     <span class=\"pl-k\">if</span> (<span class=\"pl-smi\">this</span>.<span class=\"pl-s1\">currentConnection</span> == <span class=\"pl-c1\">null</span>) { </td>\n        </tr>\n\n        <tr class=\"border-0\">\n          <td id=\"L469\" class=\"blob-num border-0 px-3 py-0 color-bg-default\" data-line-number=\"469\"></td>\n          <td id=\"LC469\" class=\"blob-code border-0 px-3 py-0 color-bg-default blob-code-inner js-file-line\">         <span class=\"pl-k\">return</span> <span class=\"pl-c1\">false</span>; </td>\n        </tr>\n\n        <tr class=\"border-0\">\n          <td id=\"L470\" class=\"blob-num border-0 px-3 py-0 color-bg-default\" data-line-number=\"470\"></td>\n          <td id=\"LC470\" class=\"blob-code border-0 px-3 py-0 color-bg-default blob-code-inner js-file-line\">     } </td>\n        </tr>\n\n        <tr class=\"border-0\">\n          <td id=\"L471\" class=\"blob-num border-0 px-3 py-0 color-bg-default\" data-line-number=\"471\"></td>\n          <td id=\"LC471\" class=\"blob-code border-0 px-3 py-0 color-bg-default blob-code-inner js-file-line\">     <span class=\"pl-smi\">int</span> <span class=\"pl-s1\">reTryTimes</span> = <span class=\"pl-s1\">healthCheckRetryTimes</span>; </td>\n        </tr>\n\n        <tr class=\"border-0\">\n          <td id=\"L472\" class=\"blob-num border-0 px-3 py-0 color-bg-default\" data-line-number=\"472\"></td>\n          <td id=\"LC472\" class=\"blob-code border-0 px-3 py-0 color-bg-default blob-code-inner js-file-line\">     <span class=\"pl-k\">while</span> (<span class=\"pl-s1\">reTryTimes</span> > <span class=\"pl-c1\">0</span>) { </td>\n        </tr>\n\n        <tr class=\"border-0\">\n          <td id=\"L473\" class=\"blob-num border-0 px-3 py-0 color-bg-default\" data-line-number=\"473\"></td>\n          <td id=\"LC473\" class=\"blob-code border-0 px-3 py-0 color-bg-default blob-code-inner js-file-line\">         <span class=\"pl-s1\">reTryTimes</span>--; </td>\n        </tr>\n\n        <tr class=\"border-0\">\n          <td id=\"L474\" class=\"blob-num border-0 px-3 py-0 color-bg-default\" data-line-number=\"474\"></td>\n          <td id=\"LC474\" class=\"blob-code border-0 px-3 py-0 color-bg-default blob-code-inner js-file-line\">         <span class=\"pl-k\">try</span> { </td>\n        </tr>\n\n        <tr class=\"border-0\">\n          <td id=\"L475\" class=\"blob-num border-0 px-3 py-0 color-bg-default\" data-line-number=\"475\"></td>\n          <td id=\"LC475\" class=\"blob-code border-0 px-3 py-0 color-bg-default blob-code-inner js-file-line\">             <span class=\"pl-smi\">Response</span> <span class=\"pl-s1\">response</span> = <span class=\"pl-smi\">this</span>.<span class=\"pl-s1\">currentConnection</span>.<span class=\"pl-en\">request</span>(<span class=\"pl-s1\">healthCheckRequest</span>, <span class=\"pl-s1\">healthCheckTimeOut</span>); </td>\n        </tr>\n\n        <tr class=\"border-0\">\n          <td id=\"L476\" class=\"blob-num border-0 px-3 py-0 color-bg-default\" data-line-number=\"476\"></td>\n          <td id=\"LC476\" class=\"blob-code border-0 px-3 py-0 color-bg-default blob-code-inner js-file-line\">             <span class=\"pl-c\">// not only check server is ok, also check connection is register.</span> </td>\n        </tr>\n\n        <tr class=\"border-0\">\n          <td id=\"L477\" class=\"blob-num border-0 px-3 py-0 color-bg-default\" data-line-number=\"477\"></td>\n          <td id=\"LC477\" class=\"blob-code border-0 px-3 py-0 color-bg-default blob-code-inner js-file-line\">             <span class=\"pl-k\">return</span> <span class=\"pl-s1\">response</span> != <span class=\"pl-c1\">null</span> && <span class=\"pl-s1\">response</span>.<span class=\"pl-en\">isSuccess</span>(); </td>\n        </tr>\n\n        <tr class=\"border-0\">\n          <td id=\"L478\" class=\"blob-num border-0 px-3 py-0 color-bg-default\" data-line-number=\"478\"></td>\n          <td id=\"LC478\" class=\"blob-code border-0 px-3 py-0 color-bg-default blob-code-inner js-file-line\">         } <span class=\"pl-k\">catch</span> (<span class=\"pl-smi\">NacosException</span> <span class=\"pl-s1\">e</span>) { </td>\n        </tr>\n\n        <tr class=\"border-0\">\n          <td id=\"L479\" class=\"blob-num border-0 px-3 py-0 color-bg-default\" data-line-number=\"479\"></td>\n          <td id=\"LC479\" class=\"blob-code border-0 px-3 py-0 color-bg-default blob-code-inner js-file-line\">             <span class=\"pl-c\">// ignore</span> </td>\n        </tr>\n\n        <tr class=\"border-0\">\n          <td id=\"L480\" class=\"blob-num border-0 px-3 py-0 color-bg-default\" data-line-number=\"480\"></td>\n          <td id=\"LC480\" class=\"blob-code border-0 px-3 py-0 color-bg-default blob-code-inner js-file-line\">         } </td>\n        </tr>\n\n        <tr class=\"border-0\">\n          <td id=\"L481\" class=\"blob-num border-0 px-3 py-0 color-bg-default\" data-line-number=\"481\"></td>\n          <td id=\"LC481\" class=\"blob-code border-0 px-3 py-0 color-bg-default blob-code-inner js-file-line\">     } </td>\n        </tr>\n\n        <tr class=\"border-0\">\n          <td id=\"L482\" class=\"blob-num border-0 px-3 py-0 color-bg-default\" data-line-number=\"482\"></td>\n          <td id=\"LC482\" class=\"blob-code border-0 px-3 py-0 color-bg-default blob-code-inner js-file-line\">     <span class=\"pl-k\">return</span> <span class=\"pl-c1\">false</span>; </td>\n        </tr>\n\n        <tr class=\"border-0\">\n          <td id=\"L483\" class=\"blob-num border-0 px-3 py-0 color-bg-default\" data-line-number=\"483\"></td>\n          <td id=\"LC483\" class=\"blob-code border-0 px-3 py-0 color-bg-default blob-code-inner js-file-line\"> } </td>\n        </tr>\n    </tbody></table>\n  </div>\n</div>\n<p></p>\n<p dir=\"auto\">I think there's a problem here, if healthCheckRetryTimes is equal to 1, it doesn't actually retry.<br>\nThe judgment condition should be\uff1areTryTimes >= 0</p>",
  "description_text": "\n\n\nnacos/common/src/main/java/com/alibaba/nacos/common/remote/client/RpcClient.java\n\n\n        Lines 466 to 483\n      in\n      0aa695e\n\n\n\n\n\n\n private boolean healthCheck() { \n\n\n\n HealthCheckRequest healthCheckRequest = new HealthCheckRequest(); \n\n\n\n if (this.currentConnection == null) { \n\n\n\n return false; \n\n\n\n     } \n\n\n\n int reTryTimes = healthCheckRetryTimes; \n\n\n\n while (reTryTimes > 0) { \n\n\n\n reTryTimes--; \n\n\n\n try { \n\n\n\n Response response = this.currentConnection.request(healthCheckRequest, healthCheckTimeOut); \n\n\n\n // not only check server is ok, also check connection is register. \n\n\n\n return response != null && response.isSuccess(); \n\n\n\n         } catch (NacosException e) { \n\n\n\n // ignore \n\n\n\n         } \n\n\n\n     } \n\n\n\n return false; \n\n\n\n } \n\n\n\n\n\nI think there's a problem here, if healthCheckRetryTimes is equal to 1, it doesn't actually retry.\nThe judgment condition should be\uff1areTryTimes >= 0"
}