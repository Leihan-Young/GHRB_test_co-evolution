{
  "issue_id": 12104,
  "issue_url": "https://github.com/checkstyle/checkstyle/issues/12104",
  "title": "Remove Global Static Locale",
  "description": "<p dir=\"auto\"></p><div class=\"Box Box--condensed my-2\">\n  <div class=\"Box-header f6\">\n    <p class=\"mb-0 text-bold\">\n      <a href=\"https://github.com/checkstyle/checkstyle/blob/a368230b7df8ca70839f97d30a8d8adebd8b9ff3/src/main/java/com/puppycrawl/tools/checkstyle/api/Violation.java#L68\">checkstyle/src/main/java/com/puppycrawl/tools/checkstyle/api/Violation.java</a>\n    </p>\n    <p class=\"mb-0 color-fg-muted\">\n         Line 68\n      in\n      <a data-pjax=\"true\" class=\"commit-tease-sha Link--inTextBlock\" href=\"/checkstyle/checkstyle/commit/a368230b7df8ca70839f97d30a8d8adebd8b9ff3\">a368230</a>\n    </p>\n  </div>\n  <div itemprop=\"text\" class=\"Box-body p-0 blob-wrapper blob-wrapper-embedded data\">\n    <table class=\"highlight tab-size mb-0 js-file-line-container\" data-tab-size=\"8\" data-paste-markdown-skip=\"\">\n\n        <tbody><tr class=\"border-0\">\n          <td id=\"L68\" class=\"blob-num border-0 px-3 py-0 color-bg-default\" data-line-number=\"68\"></td>\n          <td id=\"LC68\" class=\"blob-code border-0 px-3 py-0 color-bg-default blob-code-inner js-file-line\"> <span class=\"pl-k\">private</span> <span class=\"pl-k\">static</span> <span class=\"pl-smi\">Locale</span> <span class=\"pl-s1\">sLocale</span> = <span class=\"pl-smi\">Locale</span>.<span class=\"pl-en\">getDefault</span>(); </td>\n        </tr>\n    </tbody></table>\n  </div>\n</div>\n<br>\n<div class=\"Box Box--condensed my-2\">\n  <div class=\"Box-header f6\">\n    <p class=\"mb-0 text-bold\">\n      <a href=\"https://github.com/checkstyle/checkstyle/blob/a368230b7df8ca70839f97d30a8d8adebd8b9ff3/src/main/java/com/puppycrawl/tools/checkstyle/Checker.java#L434\">checkstyle/src/main/java/com/puppycrawl/tools/checkstyle/Checker.java</a>\n    </p>\n    <p class=\"mb-0 color-fg-muted\">\n         Line 434\n      in\n      <a data-pjax=\"true\" class=\"commit-tease-sha Link--inTextBlock\" href=\"/checkstyle/checkstyle/commit/a368230b7df8ca70839f97d30a8d8adebd8b9ff3\">a368230</a>\n    </p>\n  </div>\n  <div itemprop=\"text\" class=\"Box-body p-0 blob-wrapper blob-wrapper-embedded data\">\n    <table class=\"highlight tab-size mb-0 js-file-line-container\" data-tab-size=\"8\" data-paste-markdown-skip=\"\">\n\n        <tbody><tr class=\"border-0\">\n          <td id=\"L434\" class=\"blob-num border-0 px-3 py-0 color-bg-default\" data-line-number=\"434\"></td>\n          <td id=\"LC434\" class=\"blob-code border-0 px-3 py-0 color-bg-default blob-code-inner js-file-line\"> <span class=\"pl-smi\">Violation</span>.<span class=\"pl-en\">setLocale</span>(<span class=\"pl-s1\">locale</span>); </td>\n        </tr>\n    </tbody></table>\n  </div>\n</div>\n<p></p>\n<p dir=\"auto\">Identified in several issues,<br>\n<a class=\"issue-link js-issue-link\" data-error-text=\"Failed to load title\" data-id=\"1336226104\" data-permission-text=\"Title is private\" data-url=\"https://github.com/checkstyle/checkstyle/issues/12053\" data-hovercard-type=\"pull_request\" data-hovercard-url=\"/checkstyle/checkstyle/pull/12053/hovercard?comment_id=955646247&comment_type=review_comment\" href=\"https://github.com/checkstyle/checkstyle/pull/12053#discussion_r955646247\">#12053 (comment)</a><br>\n<a class=\"issue-link js-issue-link\" data-error-text=\"Failed to load title\" data-id=\"1350148500\" data-permission-text=\"Title is private\" data-url=\"https://github.com/checkstyle/checkstyle/issues/12101\" data-hovercard-type=\"issue\" data-hovercard-url=\"/checkstyle/checkstyle/issues/12101/hovercard\" href=\"https://github.com/checkstyle/checkstyle/issues/12101\">#12101</a><br>\n<a class=\"issue-link js-issue-link\" data-error-text=\"Failed to load title\" data-id=\"544667327\" data-permission-text=\"Title is private\" data-url=\"https://github.com/checkstyle/checkstyle/issues/7436\" data-hovercard-type=\"issue\" data-hovercard-url=\"/checkstyle/checkstyle/issues/7436/hovercard\" href=\"https://github.com/checkstyle/checkstyle/issues/7436\">#7436</a></p>\n<p dir=\"auto\">Setting any type of locale in a global area, either by <code class=\"notranslate\">Violation.setLocale</code> or <code class=\"notranslate\">Locale.setDefault</code>, is a very bad idea.</p>\n<p dir=\"auto\">It is very easy to corrupt the locale if developers creating tests aren't careful as changing this value can impact all other tests since it is global. Even if developers are careful, its hard to remember all the little places that can change the locale without in-depth knowledge all the time.</p>\n<p dir=\"auto\">Example:<br>\n</p><div class=\"Box Box--condensed my-2\">\n  <div class=\"Box-header f6\">\n    <p class=\"mb-0 text-bold\">\n      <a href=\"https://github.com/checkstyle/checkstyle/blob/d287d78e7ee1218092f0c386cddd78ea81448fc3/src/test/java/com/puppycrawl/tools/checkstyle/CheckerTest.java#L478\">checkstyle/src/test/java/com/puppycrawl/tools/checkstyle/CheckerTest.java</a>\n    </p>\n    <p class=\"mb-0 color-fg-muted\">\n         Line 478\n      in\n      <a data-pjax=\"true\" class=\"commit-tease-sha Link--inTextBlock\" href=\"/checkstyle/checkstyle/commit/d287d78e7ee1218092f0c386cddd78ea81448fc3\">d287d78</a>\n    </p>\n  </div>\n  <div itemprop=\"text\" class=\"Box-body p-0 blob-wrapper blob-wrapper-embedded data\">\n    <table class=\"highlight tab-size mb-0 js-file-line-container\" data-tab-size=\"8\" data-paste-markdown-skip=\"\">\n\n        <tbody><tr class=\"border-0\">\n          <td id=\"L478\" class=\"blob-num border-0 px-3 py-0 color-bg-default\" data-line-number=\"478\"></td>\n          <td id=\"LC478\" class=\"blob-code border-0 px-3 py-0 color-bg-default blob-code-inner js-file-line\"> <span class=\"pl-s1\">checker</span>.<span class=\"pl-en\">setLocaleLanguage</span>(<span class=\"pl-s\">\"it\"</span>); </td>\n        </tr>\n    </tbody></table>\n  </div>\n</div>\n -- We set the locale to italy and don't do any reversion. I am not sure how this hasn't been an issue already but I think we have been lucky on test run ordering.<br>\n<div class=\"Box Box--condensed my-2\">\n  <div class=\"Box-header f6\">\n    <p class=\"mb-0 text-bold\">\n      <a href=\"https://github.com/checkstyle/checkstyle/blob/0eadd97b8af5b79e7c49f82958fbb3d863bfdf61/src/it/java/org/checkstyle/base/AbstractItModuleTestSupport.java#L286\">checkstyle/src/it/java/org/checkstyle/base/AbstractItModuleTestSupport.java</a>\n    </p>\n    <p class=\"mb-0 color-fg-muted\">\n         Line 286\n      in\n      <a data-pjax=\"true\" class=\"commit-tease-sha Link--inTextBlock\" href=\"/checkstyle/checkstyle/commit/0eadd97b8af5b79e7c49f82958fbb3d863bfdf61\">0eadd97</a>\n    </p>\n  </div>\n  <div itemprop=\"text\" class=\"Box-body p-0 blob-wrapper blob-wrapper-embedded data\">\n    <table class=\"highlight tab-size mb-0 js-file-line-container\" data-tab-size=\"8\" data-paste-markdown-skip=\"\">\n\n        <tbody><tr class=\"border-0\">\n          <td id=\"L286\" class=\"blob-num border-0 px-3 py-0 color-bg-default\" data-line-number=\"286\"></td>\n          <td id=\"LC286\" class=\"blob-code border-0 px-3 py-0 color-bg-default blob-code-inner js-file-line\"> <span class=\"pl-s1\">checker</span>.<span class=\"pl-en\">setLocaleLanguage</span>(<span class=\"pl-s1\">locale</span>.<span class=\"pl-en\">getLanguage</span>()); </td>\n        </tr>\n    </tbody></table>\n  </div>\n</div>\n -- We set the locale to English but CI and most users run in English.<br>\n<div class=\"Box Box--condensed my-2\">\n  <div class=\"Box-header f6\">\n    <p class=\"mb-0 text-bold\">\n      <a href=\"https://github.com/checkstyle/checkstyle/blob/d287d78e7ee1218092f0c386cddd78ea81448fc3/src/test/java/com/puppycrawl/tools/checkstyle/api/ViolationTest.java#L445\">checkstyle/src/test/java/com/puppycrawl/tools/checkstyle/api/ViolationTest.java</a>\n    </p>\n    <p class=\"mb-0 color-fg-muted\">\n         Line 445\n      in\n      <a data-pjax=\"true\" class=\"commit-tease-sha Link--inTextBlock\" href=\"/checkstyle/checkstyle/commit/d287d78e7ee1218092f0c386cddd78ea81448fc3\">d287d78</a>\n    </p>\n  </div>\n  <div itemprop=\"text\" class=\"Box-body p-0 blob-wrapper blob-wrapper-embedded data\">\n    <table class=\"highlight tab-size mb-0 js-file-line-container\" data-tab-size=\"8\" data-paste-markdown-skip=\"\">\n\n        <tbody><tr class=\"border-0\">\n          <td id=\"L445\" class=\"blob-num border-0 px-3 py-0 color-bg-default\" data-line-number=\"445\"></td>\n          <td id=\"LC445\" class=\"blob-code border-0 px-3 py-0 color-bg-default blob-code-inner js-file-line\"> <span class=\"pl-smi\">Violation</span>.<span class=\"pl-en\">setLocale</span>(<span class=\"pl-c1\">DEFAULT_LOCALE</span>); </td>\n        </tr>\n    </tbody></table>\n  </div>\n</div>\n -- Example of where we have to be extra careful and reset the global locale back after testing.<p></p>\n<p dir=\"auto\">If we ever create a config with a locale set and load it in a test, it would also cause a global issue.</p>\n<p dir=\"auto\">We need to remove this method somehow and pass the locale either by stack or have a central, non-static, area be the main source of it like Checker.</p>\n<p dir=\"auto\">We also need to forbid <code class=\"notranslate\">Locale.setDefault</code>. (either ForbiddenAPIs or xpath)</p>",
  "description_text": "\n\n\ncheckstyle/src/main/java/com/puppycrawl/tools/checkstyle/api/Violation.java\n\n\n         Line 68\n      in\n      a368230\n\n\n\n\n\n\n private static Locale sLocale = Locale.getDefault(); \n\n\n\n\n\n\n\n\ncheckstyle/src/main/java/com/puppycrawl/tools/checkstyle/Checker.java\n\n\n         Line 434\n      in\n      a368230\n\n\n\n\n\n\n Violation.setLocale(locale); \n\n\n\n\n\nIdentified in several issues,\n#12053 (comment)\n#12101\n#7436\nSetting any type of locale in a global area, either by Violation.setLocale or Locale.setDefault, is a very bad idea.\nIt is very easy to corrupt the locale if developers creating tests aren't careful as changing this value can impact all other tests since it is global. Even if developers are careful, its hard to remember all the little places that can change the locale without in-depth knowledge all the time.\nExample:\n\n\n\ncheckstyle/src/test/java/com/puppycrawl/tools/checkstyle/CheckerTest.java\n\n\n         Line 478\n      in\n      d287d78\n\n\n\n\n\n\n checker.setLocaleLanguage(\"it\"); \n\n\n\n\n -- We set the locale to italy and don't do any reversion. I am not sure how this hasn't been an issue already but I think we have been lucky on test run ordering.\n\n\n\ncheckstyle/src/it/java/org/checkstyle/base/AbstractItModuleTestSupport.java\n\n\n         Line 286\n      in\n      0eadd97\n\n\n\n\n\n\n checker.setLocaleLanguage(locale.getLanguage()); \n\n\n\n\n -- We set the locale to English but CI and most users run in English.\n\n\n\ncheckstyle/src/test/java/com/puppycrawl/tools/checkstyle/api/ViolationTest.java\n\n\n         Line 445\n      in\n      d287d78\n\n\n\n\n\n\n Violation.setLocale(DEFAULT_LOCALE); \n\n\n\n\n -- Example of where we have to be extra careful and reset the global locale back after testing.\nIf we ever create a config with a locale set and load it in a test, it would also cause a global issue.\nWe need to remove this method somehow and pass the locale either by stack or have a central, non-static, area be the main source of it like Checker.\nWe also need to forbid Locale.setDefault. (either ForbiddenAPIs or xpath)"
}