{
  "issue_id": 5376,
  "issue_url": "https://github.com/apache/rocketmq/issues/5376",
  "title": "[TimerMessage] Unable to send dealy message after change broker param: timerMaxDelaySec",
  "description": "<p dir=\"auto\">BUG REPORT</p>\n<ul dir=\"auto\">\n<li>Please describe the issue you observed<br>\nBroker version: 5.0.0<br>\nAfter broker param timerMaxDelaySec set to 2592000(30 days),<br>\nsending delay message with custom delivery time <code class=\"notranslate\">setDeliverTimeMs</code> will get a MQBrokerException with errorMessage</li>\n</ul>\n<blockquote>\n<p dir=\"auto\">CODE: 13  DESC: timer message illegal, the delay time should not be bigger than the max delay -1702967296ms; or if set del msg, the delay time should be bigger than the current time BROKER: ip:port.</p>\n</blockquote>\n<ul dir=\"auto\">\n<li>\n<p dir=\"auto\">What is expected to see?<br>\nDelay message with custom delivery time send successfully without any exception or errorMessage.</p>\n</li>\n<li>\n<p dir=\"auto\">Other information (e.g. detailed explanation, logs, related issues, suggestions on how to fix, etc):<br>\nCode in org.apache.rocketmq.broker.util.HookUtils#transformTimerMessage.</p>\n</li>\n</ul>\n<p dir=\"auto\"><a target=\"_blank\" rel=\"noopener noreferrer nofollow\" href=\"https://user-images.githubusercontent.com/34431968/197096043-be69c1cc-6439-4b4d-88c3-8ec3f5a3df8a.png\"><img width=\"1101\" alt=\"image\" src=\"https://user-images.githubusercontent.com/34431968/197096043-be69c1cc-6439-4b4d-88c3-8ec3f5a3df8a.png\" style=\"max-width: 100%;\"></a></p>\nWhen timerMaxDelaySec set to number larger than 2147483, timerMaxDelaySec * 1000 will overflow to negative number, thus <code class=\"notranslate\">deliverMs - System.currentTimeMillis() > brokerController.getMessageStoreConfig().getTimerMaxDelaySec() * 1000</code> will always be true, and message send with custom delivery time will always get a MQBrokerException with errorMessage as above.\n<p dir=\"auto\">Is this a bug? or timerMaxDelaySec is not expected to be set to number this large?</p>\n<p dir=\"auto\">If it's a bug, <code class=\"notranslate\">timerMaxDelaySec * 1000</code> -> <code class=\"notranslate\">timerMaxDelaySec * 1000L</code> should fix this, and i'd like to submit a pr to fix this.</p>",
  "description_text": "BUG REPORT\n\nPlease describe the issue you observed\nBroker version: 5.0.0\nAfter broker param timerMaxDelaySec set to 2592000(30 days),\nsending delay message with custom delivery time setDeliverTimeMs will get a MQBrokerException with errorMessage\n\n\nCODE: 13  DESC: timer message illegal, the delay time should not be bigger than the max delay -1702967296ms; or if set del msg, the delay time should be bigger than the current time BROKER: ip:port.\n\n\n\nWhat is expected to see?\nDelay message with custom delivery time send successfully without any exception or errorMessage.\n\n\nOther information (e.g. detailed explanation, logs, related issues, suggestions on how to fix, etc):\nCode in org.apache.rocketmq.broker.util.HookUtils#transformTimerMessage.\n\n\n\nWhen timerMaxDelaySec set to number larger than 2147483, timerMaxDelaySec * 1000 will overflow to negative number, thus deliverMs - System.currentTimeMillis() > brokerController.getMessageStoreConfig().getTimerMaxDelaySec() * 1000 will always be true, and message send with custom delivery time will always get a MQBrokerException with errorMessage as above.\nIs this a bug? or timerMaxDelaySec is not expected to be set to number this large?\nIf it's a bug, timerMaxDelaySec * 1000 -> timerMaxDelaySec * 1000L should fix this, and i'd like to submit a pr to fix this."
}