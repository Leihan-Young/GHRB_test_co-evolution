{
  "issue_id": 7010,
  "issue_url": "https://github.com/apache/rocketmq/issues/7010",
  "title": "[Bug] The HandshakeHandler return when detect haproxy version need more data",
  "description": "<h3 dir=\"auto\">Before Creating the Bug Report</h3>\n<ul class=\"contains-task-list\">\n<li class=\"task-list-item\">\n<p dir=\"auto\"><input type=\"checkbox\" id=\"\" disabled=\"\" class=\"task-list-item-checkbox\" checked=\"\"> I found a bug, not just asking a question, which should be created in <a href=\"https://github.com/apache/rocketmq/discussions\">GitHub Discussions</a>.</p>\n</li>\n<li class=\"task-list-item\">\n<p dir=\"auto\"><input type=\"checkbox\" id=\"\" disabled=\"\" class=\"task-list-item-checkbox\" checked=\"\"> I have searched the <a href=\"https://github.com/apache/rocketmq/issues\">GitHub Issues</a> and <a href=\"https://github.com/apache/rocketmq/discussions\">GitHub Discussions</a>  of this repository and believe that this is not a duplicate.</p>\n</li>\n<li class=\"task-list-item\">\n<p dir=\"auto\"><input type=\"checkbox\" id=\"\" disabled=\"\" class=\"task-list-item-checkbox\" checked=\"\"> I have confirmed that this bug belongs to the current repository, not other repositories of RocketMQ.</p>\n</li>\n</ul>\n<h3 dir=\"auto\">Runtime platform environment</h3>\n<p dir=\"auto\">Linux</p>\n<h3 dir=\"auto\">RocketMQ version</h3>\n<p dir=\"auto\">develop branch</p>\n<h3 dir=\"auto\">JDK Version</h3>\n<p dir=\"auto\">1.8</p>\n<h3 dir=\"auto\">Describe the Bug</h3>\n<p dir=\"auto\">When detect the version for haproxy, it will return NEEDS_MORE_DATA when the buffer is small. But HandshakeHandler returns directly, causing the request to be discarded<br>\n<a target=\"_blank\" rel=\"noopener noreferrer\" href=\"https://private-user-images.githubusercontent.com/5010921/252328552-c74b063a-5c8d-4016-9b3c-3d8de6fcda86.png?jwt=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJnaXRodWIuY29tIiwiYXVkIjoicmF3LmdpdGh1YnVzZXJjb250ZW50LmNvbSIsImtleSI6ImtleTUiLCJleHAiOjE3MTIwNTU4NTcsIm5iZiI6MTcxMjA1NTU1NywicGF0aCI6Ii81MDEwOTIxLzI1MjMyODU1Mi1jNzRiMDYzYS01YzhkLTQwMTYtOWIzYy0zZDhkZTZmY2RhODYucG5nP1gtQW16LUFsZ29yaXRobT1BV1M0LUhNQUMtU0hBMjU2JlgtQW16LUNyZWRlbnRpYWw9QUtJQVZDT0RZTFNBNTNQUUs0WkElMkYyMDI0MDQwMiUyRnVzLWVhc3QtMSUyRnMzJTJGYXdzNF9yZXF1ZXN0JlgtQW16LURhdGU9MjAyNDA0MDJUMTA1OTE3WiZYLUFtei1FeHBpcmVzPTMwMCZYLUFtei1TaWduYXR1cmU9YTU0YzZhOTExMjM0MjdjMzI5NGQ3ZjZhOWNhNGQ4MWZlMTU0NmJjNTY3OTE3ZTUyNTk5ZmYxY2IyZTNiYWRhNyZYLUFtei1TaWduZWRIZWFkZXJzPWhvc3QmYWN0b3JfaWQ9MCZrZXlfaWQ9MCZyZXBvX2lkPTAifQ.mDFZADsGXZznKl_pOiWtrAlEnkZeghbZ8h_cA_hFOWE\"><img src=\"https://private-user-images.githubusercontent.com/5010921/252328552-c74b063a-5c8d-4016-9b3c-3d8de6fcda86.png?jwt=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJnaXRodWIuY29tIiwiYXVkIjoicmF3LmdpdGh1YnVzZXJjb250ZW50LmNvbSIsImtleSI6ImtleTUiLCJleHAiOjE3MTIwNTU4NTcsIm5iZiI6MTcxMjA1NTU1NywicGF0aCI6Ii81MDEwOTIxLzI1MjMyODU1Mi1jNzRiMDYzYS01YzhkLTQwMTYtOWIzYy0zZDhkZTZmY2RhODYucG5nP1gtQW16LUFsZ29yaXRobT1BV1M0LUhNQUMtU0hBMjU2JlgtQW16LUNyZWRlbnRpYWw9QUtJQVZDT0RZTFNBNTNQUUs0WkElMkYyMDI0MDQwMiUyRnVzLWVhc3QtMSUyRnMzJTJGYXdzNF9yZXF1ZXN0JlgtQW16LURhdGU9MjAyNDA0MDJUMTA1OTE3WiZYLUFtei1FeHBpcmVzPTMwMCZYLUFtei1TaWduYXR1cmU9YTU0YzZhOTExMjM0MjdjMzI5NGQ3ZjZhOWNhNGQ4MWZlMTU0NmJjNTY3OTE3ZTUyNTk5ZmYxY2IyZTNiYWRhNyZYLUFtei1TaWduZWRIZWFkZXJzPWhvc3QmYWN0b3JfaWQ9MCZrZXlfaWQ9MCZyZXBvX2lkPTAifQ.mDFZADsGXZznKl_pOiWtrAlEnkZeghbZ8h_cA_hFOWE\" alt=\"image\" style=\"max-width: 100%;\"></a></p>\n<h3 dir=\"auto\">Steps to Reproduce</h3>\n<ol dir=\"auto\">\n<li>The server starts with haproxy;</li>\n<li>add dubug message before return line.</li>\n<li>start a large number of clients.</li>\n</ol>\n<h3 dir=\"auto\">What Did You Expect to See?</h3>\n<p dir=\"auto\">When the detection returns NEEDS_MORE_DATA, it will wait for more data to detect again.</p>\n<h3 dir=\"auto\">What Did You See Instead?</h3>\n<p dir=\"auto\">When the detection returns NEEDS_MORE_DATA, it will wait for more data to detect again.</p>\n<h3 dir=\"auto\">Additional Context</h3>\n<p dir=\"auto\"><em>No response</em></p>",
  "description_text": "Before Creating the Bug Report\n\n\n I found a bug, not just asking a question, which should be created in GitHub Discussions.\n\n\n I have searched the GitHub Issues and GitHub Discussions  of this repository and believe that this is not a duplicate.\n\n\n I have confirmed that this bug belongs to the current repository, not other repositories of RocketMQ.\n\n\nRuntime platform environment\nLinux\nRocketMQ version\ndevelop branch\nJDK Version\n1.8\nDescribe the Bug\nWhen detect the version for haproxy, it will return NEEDS_MORE_DATA when the buffer is small. But HandshakeHandler returns directly, causing the request to be discarded\n\nSteps to Reproduce\n\nThe server starts with haproxy;\nadd dubug message before return line.\nstart a large number of clients.\n\nWhat Did You Expect to See?\nWhen the detection returns NEEDS_MORE_DATA, it will wait for more data to detect again.\nWhat Did You See Instead?\nWhen the detection returns NEEDS_MORE_DATA, it will wait for more data to detect again.\nAdditional Context\nNo response"
}