{
  "issue_id": 3199,
  "issue_url": "https://github.com/iBotPeaches/Apktool/issues/3199",
  "title": "[BUG] Regression: sparseResources is always true",
  "description": "<p dir=\"auto\">Another issue that seems to be a regression since 2.8.0: <code class=\"notranslate\">sparseResources</code> in apktool.yml is forced to <code class=\"notranslate\">true</code> regardless of whether the original APK used sparse or not.<br>\nIt's easy to reproduce:</p>\n<ol dir=\"auto\">\n<li>Decompile any APK: <code class=\"notranslate\">sparseResources</code> is <code class=\"notranslate\">true</code> in apktool.yml.</li>\n<li>Set <code class=\"notranslate\">sparseResources</code> to <code class=\"notranslate\">false</code> in apktool.yml.</li>\n<li>Recompile the APK.</li>\n<li>Decompile the rebuilt APK: <code class=\"notranslate\">sparseResources</code> is <code class=\"notranslate\">true</code> in apktool.yml again.</li>\n</ol>\n<p dir=\"auto\">This wasn't the behavior in Apktool 2.7.1-SNAPSHOT and prior.<br>\nWhile it would still work when rebuilding APKs on an Android 13 ROM, no such luck on Android 10 (other versions might be affected as well), as it causes a nasty boot failure:</p>\n<div class=\"snippet-clipboard-content notranslate position-relative overflow-auto\" data-snippet-clipboard-copy-content=\"W /system/bin/idmap2: failed to create idmap for overlay apk path \"/product/overlay/FrameworksResCommonQva.apk\": overlay \"/product/overlay/FrameworksResCommonQva.apk\" does not successfully overlay any resource -> failed to create idmap\nF libc    : Fatal signal 11 (SIGSEGV), code 1 (SEGV_MAPERR), fault addr 0x7c2f611507 in tid 2172 (idmap2), pid 2172 (idmap2)\nI crash_dump64: obtaining output fd from tombstoned, type: kDebuggerdTombstone\nI /system/bin/tombstoned: received crash request for pid 2172\nI crash_dump64: performing dump of process 2172 (target tid = 2172)\nF DEBUG   : *** *** *** *** *** *** *** *** *** *** *** *** *** *** *** ***\nF DEBUG   : Build fingerprint: 'Xiaomi/dipper/dipper:10/QKQ1.190828.002/V12.5.2.0.QEACNXM:user/release-keys'\nF DEBUG   : Revision: '0'\nF DEBUG   : ABI: 'arm64'\nF DEBUG   : Timestamp: 2023-07-23 00:33:43+0300\nF DEBUG   : pid: 2172, tid: 2172, name: idmap2  >>> /system/bin/idmap2 <<<\nF DEBUG   : uid: 0\nF DEBUG   : signal 11 (SIGSEGV), code 1 (SEGV_MAPERR), fault addr 0x7c2f611507\nF DEBUG   :     x0  000000000000216d  x1  0000007c2f229320  x2  0000007c2f200000  x3  0000000000000003\nF DEBUG   :     x4  0000000000000029  x5  7365616d6c657373  x6  7373656c6d616573  x7  7f7f7f7f7f7f7f7f\nF DEBUG   :     x8  0000007c2f1d09bc  x9  0000007c2f2413c0  x10 0000007c2f241338  x11 0000000000000011\nF DEBUG   :     x12 00000000000002b1  x13 0000007c2f1d0a10  x14 0000007c2f1d09c0  x15 000000000044002f\nF DEBUG   :     x16 0000007c2f1d14d8  x17 0000007cb095c8f0  x18 0000007cb1a7e000  x19 0000007c2f2ba600\nF DEBUG   :     x20 0000000000000007  x21 0000007fe36c04c0  x22 0000007c2f2ba600  x23 0000007c2f2292f0\nF DEBUG   :     x24 0000007cb0da2020  x25 0000007fe36c04da  x26 0000007c2f246180  x27 0000007c2f2462e8\nF DEBUG   :     x28 0000007fe36c0524  x29 0000007fe36c04b0\nF DEBUG   :     sp  0000007fe36c0490  lr  0000007caff577cc  pc  0000007caff57844\nF DEBUG   : \nF DEBUG   : backtrace:\nF DEBUG   :       #00 pc 0000000000043844  /system/lib64/libandroidfw.so (android::LoadedPackage::FindEntryByName(std::__1::basic_string<char16_t, std::__1::char_traits<char16_t>, std::__1::allocator<char16_t>> const&, std::__1::basic_string<char16_t, std::__1::char_traits<char16_t>, std::__1::allocator<char16_t>> const&) const+220) (BuildId: 56e62e9e87e328cab13d1b88d7c2cca0)\nF DEBUG   :       #01 pc 0000000000039484  /system/lib64/libandroidfw.so (android::AssetManager2::GetResourceId(std::__1::basic_string<char, std::__1::char_traits<char>, std::__1::allocator<char>> const&, std::__1::basic_string<char, std::__1::char_traits<char>, std::__1::allocator<char>> const&, std::__1::basic_string<char, std::__1::char_traits<char>, std::__1::allocator<char>> const&) const+1016) (BuildId: 56e62e9e87e328cab13d1b88d7c2cca0)\nF DEBUG   :       #02 pc 00000000000134c0  /system/lib64/libidmap2.so (android::idmap2::Idmap::FromApkAssets(std::__1::basic_string<char, std::__1::char_traits<char>, std::__1::allocator<char>> const&, android::ApkAssets const&, std::__1::basic_string<char, std::__1::char_traits<char>, std::__1::allocator<char>> const&, android::ApkAssets const&, unsigned int const&, bool)+2188) (BuildId: 140835afee413473b2c971a844f42dfa)\nF DEBUG   :       #03 pc 0000000000007794  /system/bin/idmap2 (Create(std::__1::vector<std::__1::basic_string<char, std::__1::char_traits<char>, std::__1::allocator<char>>, std::__1::allocator<std::__1::basic_string<char, std::__1::char_traits<char>, std::__1::allocator<char>>>> const&)+1860) (BuildId: f14382a5540f8590c832167932481011)\nF DEBUG   :       #04 pc 0000000000010194  /system/bin/idmap2 (Scan(std::__1::vector<std::__1::basic_string<char, std::__1::char_traits<char>, std::__1::allocator<char>>, std::__1::allocator<std::__1::basic_string<char, std::__1::char_traits<char>, std::__1::allocator<char>>>> const&)+8568) (BuildId: f14382a5540f8590c832167932481011)\nF DEBUG   :       #05 pc 000000000000d244  /system/bin/idmap2 (main+1400) (BuildId: f14382a5540hf8590c832167932481011)\nF DEBUG   :       #06 pc 000000000006ebc4  /apex/com.android.runtime/lib64/bionic/libc.so (__libc_init+108) (BuildId: f6cc5d2d702265511937b56460b37693)\nE /system/bin/tombstoned: Tombstone written to: /data/tombstones/tombstone_00\nE asset   : failed to execute idmap2\nW AssetManager: 'idmap2 --scan' failed: no static=\"true\" overlays targeting \"android\" will be loaded\nW /system/bin/idmap2: failed to create idmap for overlay apk path \"/vendor/overlay/MiuiFrameworkResOverlay.apk\": overlay \"/vendor/overlay/MiuiFrameworkResOverlay.apk\" does not successfully overlay any resource -> failed to create idmap\"><pre class=\"notranslate\"><code class=\"notranslate\">W /system/bin/idmap2: failed to create idmap for overlay apk path \"/product/overlay/FrameworksResCommonQva.apk\": overlay \"/product/overlay/FrameworksResCommonQva.apk\" does not successfully overlay any resource -> failed to create idmap\nF libc    : Fatal signal 11 (SIGSEGV), code 1 (SEGV_MAPERR), fault addr 0x7c2f611507 in tid 2172 (idmap2), pid 2172 (idmap2)\nI crash_dump64: obtaining output fd from tombstoned, type: kDebuggerdTombstone\nI /system/bin/tombstoned: received crash request for pid 2172\nI crash_dump64: performing dump of process 2172 (target tid = 2172)\nF DEBUG   : *** *** *** *** *** *** *** *** *** *** *** *** *** *** *** ***\nF DEBUG   : Build fingerprint: 'Xiaomi/dipper/dipper:10/QKQ1.190828.002/V12.5.2.0.QEACNXM:user/release-keys'\nF DEBUG   : Revision: '0'\nF DEBUG   : ABI: 'arm64'\nF DEBUG   : Timestamp: 2023-07-23 00:33:43+0300\nF DEBUG   : pid: 2172, tid: 2172, name: idmap2  >>> /system/bin/idmap2 <<<\nF DEBUG   : uid: 0\nF DEBUG   : signal 11 (SIGSEGV), code 1 (SEGV_MAPERR), fault addr 0x7c2f611507\nF DEBUG   :     x0  000000000000216d  x1  0000007c2f229320  x2  0000007c2f200000  x3  0000000000000003\nF DEBUG   :     x4  0000000000000029  x5  7365616d6c657373  x6  7373656c6d616573  x7  7f7f7f7f7f7f7f7f\nF DEBUG   :     x8  0000007c2f1d09bc  x9  0000007c2f2413c0  x10 0000007c2f241338  x11 0000000000000011\nF DEBUG   :     x12 00000000000002b1  x13 0000007c2f1d0a10  x14 0000007c2f1d09c0  x15 000000000044002f\nF DEBUG   :     x16 0000007c2f1d14d8  x17 0000007cb095c8f0  x18 0000007cb1a7e000  x19 0000007c2f2ba600\nF DEBUG   :     x20 0000000000000007  x21 0000007fe36c04c0  x22 0000007c2f2ba600  x23 0000007c2f2292f0\nF DEBUG   :     x24 0000007cb0da2020  x25 0000007fe36c04da  x26 0000007c2f246180  x27 0000007c2f2462e8\nF DEBUG   :     x28 0000007fe36c0524  x29 0000007fe36c04b0\nF DEBUG   :     sp  0000007fe36c0490  lr  0000007caff577cc  pc  0000007caff57844\nF DEBUG   : \nF DEBUG   : backtrace:\nF DEBUG   :       #00 pc 0000000000043844  /system/lib64/libandroidfw.so (android::LoadedPackage::FindEntryByName(std::__1::basic_string<char16_t, std::__1::char_traits<char16_t>, std::__1::allocator<char16_t>> const&, std::__1::basic_string<char16_t, std::__1::char_traits<char16_t>, std::__1::allocator<char16_t>> const&) const+220) (BuildId: 56e62e9e87e328cab13d1b88d7c2cca0)\nF DEBUG   :       #01 pc 0000000000039484  /system/lib64/libandroidfw.so (android::AssetManager2::GetResourceId(std::__1::basic_string<char, std::__1::char_traits<char>, std::__1::allocator<char>> const&, std::__1::basic_string<char, std::__1::char_traits<char>, std::__1::allocator<char>> const&, std::__1::basic_string<char, std::__1::char_traits<char>, std::__1::allocator<char>> const&) const+1016) (BuildId: 56e62e9e87e328cab13d1b88d7c2cca0)\nF DEBUG   :       #02 pc 00000000000134c0  /system/lib64/libidmap2.so (android::idmap2::Idmap::FromApkAssets(std::__1::basic_string<char, std::__1::char_traits<char>, std::__1::allocator<char>> const&, android::ApkAssets const&, std::__1::basic_string<char, std::__1::char_traits<char>, std::__1::allocator<char>> const&, android::ApkAssets const&, unsigned int const&, bool)+2188) (BuildId: 140835afee413473b2c971a844f42dfa)\nF DEBUG   :       #03 pc 0000000000007794  /system/bin/idmap2 (Create(std::__1::vector<std::__1::basic_string<char, std::__1::char_traits<char>, std::__1::allocator<char>>, std::__1::allocator<std::__1::basic_string<char, std::__1::char_traits<char>, std::__1::allocator<char>>>> const&)+1860) (BuildId: f14382a5540f8590c832167932481011)\nF DEBUG   :       #04 pc 0000000000010194  /system/bin/idmap2 (Scan(std::__1::vector<std::__1::basic_string<char, std::__1::char_traits<char>, std::__1::allocator<char>>, std::__1::allocator<std::__1::basic_string<char, std::__1::char_traits<char>, std::__1::allocator<char>>>> const&)+8568) (BuildId: f14382a5540f8590c832167932481011)\nF DEBUG   :       #05 pc 000000000000d244  /system/bin/idmap2 (main+1400) (BuildId: f14382a5540hf8590c832167932481011)\nF DEBUG   :       #06 pc 000000000006ebc4  /apex/com.android.runtime/lib64/bionic/libc.so (__libc_init+108) (BuildId: f6cc5d2d702265511937b56460b37693)\nE /system/bin/tombstoned: Tombstone written to: /data/tombstones/tombstone_00\nE asset   : failed to execute idmap2\nW AssetManager: 'idmap2 --scan' failed: no static=\"true\" overlays targeting \"android\" will be loaded\nW /system/bin/idmap2: failed to create idmap for overlay apk path \"/vendor/overlay/MiuiFrameworkResOverlay.apk\": overlay \"/vendor/overlay/MiuiFrameworkResOverlay.apk\" does not successfully overlay any resource -> failed to create idmap\n</code></pre></div>",
  "description_text": "Another issue that seems to be a regression since 2.8.0: sparseResources in apktool.yml is forced to true regardless of whether the original APK used sparse or not.\nIt's easy to reproduce:\n\nDecompile any APK: sparseResources is true in apktool.yml.\nSet sparseResources to false in apktool.yml.\nRecompile the APK.\nDecompile the rebuilt APK: sparseResources is true in apktool.yml again.\n\nThis wasn't the behavior in Apktool 2.7.1-SNAPSHOT and prior.\nWhile it would still work when rebuilding APKs on an Android 13 ROM, no such luck on Android 10 (other versions might be affected as well), as it causes a nasty boot failure:\n failed to create idmap\nF libc    : Fatal signal 11 (SIGSEGV), code 1 (SEGV_MAPERR), fault addr 0x7c2f611507 in tid 2172 (idmap2), pid 2172 (idmap2)\nI crash_dump64: obtaining output fd from tombstoned, type: kDebuggerdTombstone\nI /system/bin/tombstoned: received crash request for pid 2172\nI crash_dump64: performing dump of process 2172 (target tid = 2172)\nF DEBUG   : *** *** *** *** *** *** *** *** *** *** *** *** *** *** *** ***\nF DEBUG   : Build fingerprint: 'Xiaomi/dipper/dipper:10/QKQ1.190828.002/V12.5.2.0.QEACNXM:user/release-keys'\nF DEBUG   : Revision: '0'\nF DEBUG   : ABI: 'arm64'\nF DEBUG   : Timestamp: 2023-07-23 00:33:43+0300\nF DEBUG   : pid: 2172, tid: 2172, name: idmap2  >>> /system/bin/idmap2 <<<\nF DEBUG   : uid: 0\nF DEBUG   : signal 11 (SIGSEGV), code 1 (SEGV_MAPERR), fault addr 0x7c2f611507\nF DEBUG   :     x0  000000000000216d  x1  0000007c2f229320  x2  0000007c2f200000  x3  0000000000000003\nF DEBUG   :     x4  0000000000000029  x5  7365616d6c657373  x6  7373656c6d616573  x7  7f7f7f7f7f7f7f7f\nF DEBUG   :     x8  0000007c2f1d09bc  x9  0000007c2f2413c0  x10 0000007c2f241338  x11 0000000000000011\nF DEBUG   :     x12 00000000000002b1  x13 0000007c2f1d0a10  x14 0000007c2f1d09c0  x15 000000000044002f\nF DEBUG   :     x16 0000007c2f1d14d8  x17 0000007cb095c8f0  x18 0000007cb1a7e000  x19 0000007c2f2ba600\nF DEBUG   :     x20 0000000000000007  x21 0000007fe36c04c0  x22 0000007c2f2ba600  x23 0000007c2f2292f0\nF DEBUG   :     x24 0000007cb0da2020  x25 0000007fe36c04da  x26 0000007c2f246180  x27 0000007c2f2462e8\nF DEBUG   :     x28 0000007fe36c0524  x29 0000007fe36c04b0\nF DEBUG   :     sp  0000007fe36c0490  lr  0000007caff577cc  pc  0000007caff57844\nF DEBUG   : \nF DEBUG   : backtrace:\nF DEBUG   :       #00 pc 0000000000043844  /system/lib64/libandroidfw.so (android::LoadedPackage::FindEntryByName(std::__1::basic_string, std::__1::allocator> const&, std::__1::basic_string, std::__1::allocator> const&) const+220) (BuildId: 56e62e9e87e328cab13d1b88d7c2cca0)\nF DEBUG   :       #01 pc 0000000000039484  /system/lib64/libandroidfw.so (android::AssetManager2::GetResourceId(std::__1::basic_string, std::__1::allocator> const&, std::__1::basic_string, std::__1::allocator> const&, std::__1::basic_string, std::__1::allocator> const&) const+1016) (BuildId: 56e62e9e87e328cab13d1b88d7c2cca0)\nF DEBUG   :       #02 pc 00000000000134c0  /system/lib64/libidmap2.so (android::idmap2::Idmap::FromApkAssets(std::__1::basic_string, std::__1::allocator> const&, android::ApkAssets const&, std::__1::basic_string, std::__1::allocator> const&, android::ApkAssets const&, unsigned int const&, bool)+2188) (BuildId: 140835afee413473b2c971a844f42dfa)\nF DEBUG   :       #03 pc 0000000000007794  /system/bin/idmap2 (Create(std::__1::vector, std::__1::allocator>, std::__1::allocator, std::__1::allocator>>> const&)+1860) (BuildId: f14382a5540f8590c832167932481011)\nF DEBUG   :       #04 pc 0000000000010194  /system/bin/idmap2 (Scan(std::__1::vector, std::__1::allocator>, std::__1::allocator, std::__1::allocator>>> const&)+8568) (BuildId: f14382a5540f8590c832167932481011)\nF DEBUG   :       #05 pc 000000000000d244  /system/bin/idmap2 (main+1400) (BuildId: f14382a5540hf8590c832167932481011)\nF DEBUG   :       #06 pc 000000000006ebc4  /apex/com.android.runtime/lib64/bionic/libc.so (__libc_init+108) (BuildId: f6cc5d2d702265511937b56460b37693)\nE /system/bin/tombstoned: Tombstone written to: /data/tombstones/tombstone_00\nE asset   : failed to execute idmap2\nW AssetManager: 'idmap2 --scan' failed: no static=\"true\" overlays targeting \"android\" will be loaded\nW /system/bin/idmap2: failed to create idmap for overlay apk path \"/vendor/overlay/MiuiFrameworkResOverlay.apk\": overlay \"/vendor/overlay/MiuiFrameworkResOverlay.apk\" does not successfully overlay any resource -> failed to create idmap\">W /system/bin/idmap2: failed to create idmap for overlay apk path \"/product/overlay/FrameworksResCommonQva.apk\": overlay \"/product/overlay/FrameworksResCommonQva.apk\" does not successfully overlay any resource -> failed to create idmap\nF libc    : Fatal signal 11 (SIGSEGV), code 1 (SEGV_MAPERR), fault addr 0x7c2f611507 in tid 2172 (idmap2), pid 2172 (idmap2)\nI crash_dump64: obtaining output fd from tombstoned, type: kDebuggerdTombstone\nI /system/bin/tombstoned: received crash request for pid 2172\nI crash_dump64: performing dump of process 2172 (target tid = 2172)\nF DEBUG   : *** *** *** *** *** *** *** *** *** *** *** *** *** *** *** ***\nF DEBUG   : Build fingerprint: 'Xiaomi/dipper/dipper:10/QKQ1.190828.002/V12.5.2.0.QEACNXM:user/release-keys'\nF DEBUG   : Revision: '0'\nF DEBUG   : ABI: 'arm64'\nF DEBUG   : Timestamp: 2023-07-23 00:33:43+0300\nF DEBUG   : pid: 2172, tid: 2172, name: idmap2  >>> /system/bin/idmap2 <<<\nF DEBUG   : uid: 0\nF DEBUG   : signal 11 (SIGSEGV), code 1 (SEGV_MAPERR), fault addr 0x7c2f611507\nF DEBUG   :     x0  000000000000216d  x1  0000007c2f229320  x2  0000007c2f200000  x3  0000000000000003\nF DEBUG   :     x4  0000000000000029  x5  7365616d6c657373  x6  7373656c6d616573  x7  7f7f7f7f7f7f7f7f\nF DEBUG   :     x8  0000007c2f1d09bc  x9  0000007c2f2413c0  x10 0000007c2f241338  x11 0000000000000011\nF DEBUG   :     x12 00000000000002b1  x13 0000007c2f1d0a10  x14 0000007c2f1d09c0  x15 000000000044002f\nF DEBUG   :     x16 0000007c2f1d14d8  x17 0000007cb095c8f0  x18 0000007cb1a7e000  x19 0000007c2f2ba600\nF DEBUG   :     x20 0000000000000007  x21 0000007fe36c04c0  x22 0000007c2f2ba600  x23 0000007c2f2292f0\nF DEBUG   :     x24 0000007cb0da2020  x25 0000007fe36c04da  x26 0000007c2f246180  x27 0000007c2f2462e8\nF DEBUG   :     x28 0000007fe36c0524  x29 0000007fe36c04b0\nF DEBUG   :     sp  0000007fe36c0490  lr  0000007caff577cc  pc  0000007caff57844\nF DEBUG   : \nF DEBUG   : backtrace:\nF DEBUG   :       #00 pc 0000000000043844  /system/lib64/libandroidfw.so (android::LoadedPackage::FindEntryByName(std::__1::basic_string, std::__1::allocator> const&, std::__1::basic_string, std::__1::allocator> const&) const+220) (BuildId: 56e62e9e87e328cab13d1b88d7c2cca0)\nF DEBUG   :       #01 pc 0000000000039484  /system/lib64/libandroidfw.so (android::AssetManager2::GetResourceId(std::__1::basic_string, std::__1::allocator> const&, std::__1::basic_string, std::__1::allocator> const&, std::__1::basic_string, std::__1::allocator> const&) const+1016) (BuildId: 56e62e9e87e328cab13d1b88d7c2cca0)\nF DEBUG   :       #02 pc 00000000000134c0  /system/lib64/libidmap2.so (android::idmap2::Idmap::FromApkAssets(std::__1::basic_string, std::__1::allocator> const&, android::ApkAssets const&, std::__1::basic_string, std::__1::allocator> const&, android::ApkAssets const&, unsigned int const&, bool)+2188) (BuildId: 140835afee413473b2c971a844f42dfa)\nF DEBUG   :       #03 pc 0000000000007794  /system/bin/idmap2 (Create(std::__1::vector, std::__1::allocator>, std::__1::allocator, std::__1::allocator>>> const&)+1860) (BuildId: f14382a5540f8590c832167932481011)\nF DEBUG   :       #04 pc 0000000000010194  /system/bin/idmap2 (Scan(std::__1::vector, std::__1::allocator>, std::__1::allocator, std::__1::allocator>>> const&)+8568) (BuildId: f14382a5540f8590c832167932481011)\nF DEBUG   :       #05 pc 000000000000d244  /system/bin/idmap2 (main+1400) (BuildId: f14382a5540hf8590c832167932481011)\nF DEBUG   :       #06 pc 000000000006ebc4  /apex/com.android.runtime/lib64/bionic/libc.so (__libc_init+108) (BuildId: f6cc5d2d702265511937b56460b37693)\nE /system/bin/tombstoned: Tombstone written to: /data/tombstones/tombstone_00\nE asset   : failed to execute idmap2\nW AssetManager: 'idmap2 --scan' failed: no static=\"true\" overlays targeting \"android\" will be loaded\nW /system/bin/idmap2: failed to create idmap for overlay apk path \"/vendor/overlay/MiuiFrameworkResOverlay.apk\": overlay \"/vendor/overlay/MiuiFrameworkResOverlay.apk\" does not successfully overlay any resource -> failed to create idmap\n"
}