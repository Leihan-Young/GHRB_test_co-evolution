{
  "issue_id": 7437,
  "issue_url": "https://github.com/apache/rocketmq/issues/7437",
  "title": "[Bug] A bug in the CRC check of commitlog",
  "description": "<h3 dir=\"auto\">Before Creating the Bug Report</h3>\n<ul class=\"contains-task-list\">\n<li class=\"task-list-item\">\n<p dir=\"auto\"><input type=\"checkbox\" id=\"\" disabled=\"\" class=\"task-list-item-checkbox\" checked=\"\"> I found a bug, not just asking a question, which should be created in <a href=\"https://github.com/apache/rocketmq/discussions\">GitHub Discussions</a>.</p>\n</li>\n<li class=\"task-list-item\">\n<p dir=\"auto\"><input type=\"checkbox\" id=\"\" disabled=\"\" class=\"task-list-item-checkbox\" checked=\"\"> I have searched the <a href=\"https://github.com/apache/rocketmq/issues\">GitHub Issues</a> and <a href=\"https://github.com/apache/rocketmq/discussions\">GitHub Discussions</a>  of this repository and believe that this is not a duplicate.</p>\n</li>\n<li class=\"task-list-item\">\n<p dir=\"auto\"><input type=\"checkbox\" id=\"\" disabled=\"\" class=\"task-list-item-checkbox\" checked=\"\"> I have confirmed that this bug belongs to the current repository, not other repositories of RocketMQ.</p>\n</li>\n</ul>\n<h3 dir=\"auto\">Runtime platform environment</h3>\n<p dir=\"auto\">Linux</p>\n<h3 dir=\"auto\">RocketMQ version</h3>\n<p dir=\"auto\">5.1.5</p>\n<h3 dir=\"auto\">JDK Version</h3>\n<p dir=\"auto\">JDK11</p>\n<h3 dir=\"auto\">Describe the Bug</h3>\n<p dir=\"auto\">A shutdown occurs when the message is not completely written, causing all characters at the end of the message to be unwritten.<br>\n<a target=\"_blank\" rel=\"noopener noreferrer\" href=\"https://private-user-images.githubusercontent.com/36399867/273817102-0fb6c0bd-79cb-4866-aeea-eff47c55fb8e.png?jwt=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJnaXRodWIuY29tIiwiYXVkIjoicmF3LmdpdGh1YnVzZXJjb250ZW50LmNvbSIsImtleSI6ImtleTUiLCJleHAiOjE3MTIwNTYyMzAsIm5iZiI6MTcxMjA1NTkzMCwicGF0aCI6Ii8zNjM5OTg2Ny8yNzM4MTcxMDItMGZiNmMwYmQtNzljYi00ODY2LWFlZWEtZWZmNDdjNTVmYjhlLnBuZz9YLUFtei1BbGdvcml0aG09QVdTNC1ITUFDLVNIQTI1NiZYLUFtei1DcmVkZW50aWFsPUFLSUFWQ09EWUxTQTUzUFFLNFpBJTJGMjAyNDA0MDIlMkZ1cy1lYXN0LTElMkZzMyUyRmF3czRfcmVxdWVzdCZYLUFtei1EYXRlPTIwMjQwNDAyVDExMDUzMFomWC1BbXotRXhwaXJlcz0zMDAmWC1BbXotU2lnbmF0dXJlPTM0ZDM1OWM1MGE2OTZhNGRiNDJjOTdlMTM4YjRkNTY2NmZhOTgxYjJhMDFjOTQyNDQ5ODMyZDFjZmVkNmNjNjImWC1BbXotU2lnbmVkSGVhZGVycz1ob3N0JmFjdG9yX2lkPTAma2V5X2lkPTAmcmVwb19pZD0wIn0.psA2j5kmxnel_g7YTshsNLl-A292O-biE5rzQ1ylDfQ\"><img src=\"https://private-user-images.githubusercontent.com/36399867/273817102-0fb6c0bd-79cb-4866-aeea-eff47c55fb8e.png?jwt=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJnaXRodWIuY29tIiwiYXVkIjoicmF3LmdpdGh1YnVzZXJjb250ZW50LmNvbSIsImtleSI6ImtleTUiLCJleHAiOjE3MTIwNTYyMzAsIm5iZiI6MTcxMjA1NTkzMCwicGF0aCI6Ii8zNjM5OTg2Ny8yNzM4MTcxMDItMGZiNmMwYmQtNzljYi00ODY2LWFlZWEtZWZmNDdjNTVmYjhlLnBuZz9YLUFtei1BbGdvcml0aG09QVdTNC1ITUFDLVNIQTI1NiZYLUFtei1DcmVkZW50aWFsPUFLSUFWQ09EWUxTQTUzUFFLNFpBJTJGMjAyNDA0MDIlMkZ1cy1lYXN0LTElMkZzMyUyRmF3czRfcmVxdWVzdCZYLUFtei1EYXRlPTIwMjQwNDAyVDExMDUzMFomWC1BbXotRXhwaXJlcz0zMDAmWC1BbXotU2lnbmF0dXJlPTM0ZDM1OWM1MGE2OTZhNGRiNDJjOTdlMTM4YjRkNTY2NmZhOTgxYjJhMDFjOTQyNDQ5ODMyZDFjZmVkNmNjNjImWC1BbXotU2lnbmVkSGVhZGVycz1ob3N0JmFjdG9yX2lkPTAma2V5X2lkPTAmcmVwb19pZD0wIn0.psA2j5kmxnel_g7YTshsNLl-A292O-biE5rzQ1ylDfQ\" alt=\"image\" style=\"max-width: 100%;\"></a></p>\n<p dir=\"auto\">recover uses magicCode and bodyCrc to verify whether the writing is successful, but properties do not participate in the verification and belong to the end of the entire message.</p>\n<p dir=\"auto\">Therefore, it cannot be verified that the data of this message is wrong. If you continue to use this error message, unpredictable consequences will occur, such as blocking timerMessage distribution.</p>\n<h3 dir=\"auto\">Steps to Reproduce</h3>\n<p dir=\"auto\">When there is an abnormal downtime, the body of the last message is written successfully, but the properties are not written successfully.</p>\n<h3 dir=\"auto\">What Did You Expect to See?</h3>\n<p dir=\"auto\">During recover, data abnormalities in any part of the entire message can be verified.</p>\n<h3 dir=\"auto\">What Did You See Instead?</h3>\n<p dir=\"auto\">Exceptions other than the body field cannot be found during recover.</p>\n<h3 dir=\"auto\">Additional Context</h3>\n<p dir=\"auto\"><em>No response</em></p>",
  "description_text": "Before Creating the Bug Report\n\n\n I found a bug, not just asking a question, which should be created in GitHub Discussions.\n\n\n I have searched the GitHub Issues and GitHub Discussions  of this repository and believe that this is not a duplicate.\n\n\n I have confirmed that this bug belongs to the current repository, not other repositories of RocketMQ.\n\n\nRuntime platform environment\nLinux\nRocketMQ version\n5.1.5\nJDK Version\nJDK11\nDescribe the Bug\nA shutdown occurs when the message is not completely written, causing all characters at the end of the message to be unwritten.\n\nrecover uses magicCode and bodyCrc to verify whether the writing is successful, but properties do not participate in the verification and belong to the end of the entire message.\nTherefore, it cannot be verified that the data of this message is wrong. If you continue to use this error message, unpredictable consequences will occur, such as blocking timerMessage distribution.\nSteps to Reproduce\nWhen there is an abnormal downtime, the body of the last message is written successfully, but the properties are not written successfully.\nWhat Did You Expect to See?\nDuring recover, data abnormalities in any part of the entire message can be verified.\nWhat Did You See Instead?\nExceptions other than the body field cannot be found during recover.\nAdditional Context\nNo response"
}