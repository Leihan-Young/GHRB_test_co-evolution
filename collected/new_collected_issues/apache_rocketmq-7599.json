{
  "issue_id": 7355,
  "issue_url": "https://github.com/apache/rocketmq/issues/7355",
  "title": "[Bug] ConsumeQueue building exception caused by host downtime",
  "description": "<h3 dir=\"auto\">Before Creating the Bug Report</h3>\n<ul class=\"contains-task-list\">\n<li class=\"task-list-item\">\n<p dir=\"auto\"><input type=\"checkbox\" id=\"\" disabled=\"\" class=\"task-list-item-checkbox\" checked=\"\"> I found a bug, not just asking a question, which should be created in <a href=\"https://github.com/apache/rocketmq/discussions\">GitHub Discussions</a>.</p>\n</li>\n<li class=\"task-list-item\">\n<p dir=\"auto\"><input type=\"checkbox\" id=\"\" disabled=\"\" class=\"task-list-item-checkbox\" checked=\"\"> I have searched the <a href=\"https://github.com/apache/rocketmq/issues\">GitHub Issues</a> and <a href=\"https://github.com/apache/rocketmq/discussions\">GitHub Discussions</a>  of this repository and believe that this is not a duplicate.</p>\n</li>\n<li class=\"task-list-item\">\n<p dir=\"auto\"><input type=\"checkbox\" id=\"\" disabled=\"\" class=\"task-list-item-checkbox\" checked=\"\"> I have confirmed that this bug belongs to the current repository, not other repositories of RocketMQ.</p>\n</li>\n</ul>\n<h3 dir=\"auto\">Runtime platform environment</h3>\n<p dir=\"auto\">OS: CentOS 7.3</p>\n<h3 dir=\"auto\">RocketMQ version</h3>\n<p dir=\"auto\">4.8.x DLedger Model</p>\n<h3 dir=\"auto\">JDK Version</h3>\n<p dir=\"auto\">openjdk version \"1.8.0_202\"</p>\n<h3 dir=\"auto\">Describe the Bug</h3>\n<ul dir=\"auto\">\n<li>A downtime occurred on the slave node</li>\n<li>When the Broker process is started, the following exception log appears during building consumeQueue index.</li>\n</ul>\n<div class=\"snippet-clipboard-content notranslate position-relative overflow-auto\" data-snippet-clipboard-copy-content=\"[BUG]logic queue order maybe wrong, expectLogicOffset: 5762122360 currentLogicOffset: 5762121440 Topic: hlth-center-data QID: 1 Diff: 920\"><pre lang=\"log\" class=\"notranslate\"><code class=\"notranslate\">[BUG]logic queue order maybe wrong, expectLogicOffset: 5762122360 currentLogicOffset: 5762121440 Topic: hlth-center-data QID: 1 Diff: 920\n</code></pre></div>\n<ul dir=\"auto\">\n<li>Delete all consumeQueues and back to normal.</li>\n</ul>\n<h3 dir=\"auto\">Steps to Reproduce</h3>\n<ul dir=\"auto\">\n<li>stop the slave node.</li>\n<li>delete the last consumeQueue of a queue.</li>\n<li>start the slave node.</li>\n</ul>\n<h3 dir=\"auto\">What Did You Expect to See?</h3>\n<p dir=\"auto\">This log should not be printed.</p>\n<h3 dir=\"auto\">What Did You See Instead?</h3>\n<div class=\"snippet-clipboard-content notranslate position-relative overflow-auto\" data-snippet-clipboard-copy-content=\"[BUG]logic queue order maybe wrong, expectLogicOffset: 5762122360 currentLogicOffset: 5762121440 Topic: hlth-center-data QID: 1 Diff: 920\"><pre lang=\"log\" class=\"notranslate\"><code class=\"notranslate\">[BUG]logic queue order maybe wrong, expectLogicOffset: 5762122360 currentLogicOffset: 5762121440 Topic: hlth-center-data QID: 1 Diff: 920\n</code></pre></div>\n<h3 dir=\"auto\">Additional Context</h3>\n<h3 dir=\"auto\"># Possible reason</h3>\n<ul dir=\"auto\">\n<li>A power outage on the host causes the loss of unpersisted consumeQueue records in the pagecache.</li>\n</ul>\n<h3 dir=\"auto\"># Process</h3>\n<ul dir=\"auto\">\n<li>ConsumeQueue files are flushed asynchronously, executed once every 1 second<br>\n<a target=\"_blank\" rel=\"noopener noreferrer\" href=\"https://private-user-images.githubusercontent.com/46882838/267642558-7320145a-e287-4642-ba7d-84b763194699.png?jwt=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJnaXRodWIuY29tIiwiYXVkIjoicmF3LmdpdGh1YnVzZXJjb250ZW50LmNvbSIsImtleSI6ImtleTUiLCJleHAiOjE3MTIwNTYzMzUsIm5iZiI6MTcxMjA1NjAzNSwicGF0aCI6Ii80Njg4MjgzOC8yNjc2NDI1NTgtNzMyMDE0NWEtZTI4Ny00NjQyLWJhN2QtODRiNzYzMTk0Njk5LnBuZz9YLUFtei1BbGdvcml0aG09QVdTNC1ITUFDLVNIQTI1NiZYLUFtei1DcmVkZW50aWFsPUFLSUFWQ09EWUxTQTUzUFFLNFpBJTJGMjAyNDA0MDIlMkZ1cy1lYXN0LTElMkZzMyUyRmF3czRfcmVxdWVzdCZYLUFtei1EYXRlPTIwMjQwNDAyVDExMDcxNVomWC1BbXotRXhwaXJlcz0zMDAmWC1BbXotU2lnbmF0dXJlPTU3MTBkZDQ2NDQwNjQ4MDIwYjQyYWVmMDMzODlmODUzY2Y0MWIwMTA2ZmMzOGEwZWI3MTBkZjc5NjhkMmNmNzEmWC1BbXotU2lnbmVkSGVhZGVycz1ob3N0JmFjdG9yX2lkPTAma2V5X2lkPTAmcmVwb19pZD0wIn0.MaUGQdwwbswq8ymZ1iVTuKm0ySCFhdW56leXA6jRMFI\"><img src=\"https://private-user-images.githubusercontent.com/46882838/267642558-7320145a-e287-4642-ba7d-84b763194699.png?jwt=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJnaXRodWIuY29tIiwiYXVkIjoicmF3LmdpdGh1YnVzZXJjb250ZW50LmNvbSIsImtleSI6ImtleTUiLCJleHAiOjE3MTIwNTYzMzUsIm5iZiI6MTcxMjA1NjAzNSwicGF0aCI6Ii80Njg4MjgzOC8yNjc2NDI1NTgtNzMyMDE0NWEtZTI4Ny00NjQyLWJhN2QtODRiNzYzMTk0Njk5LnBuZz9YLUFtei1BbGdvcml0aG09QVdTNC1ITUFDLVNIQTI1NiZYLUFtei1DcmVkZW50aWFsPUFLSUFWQ09EWUxTQTUzUFFLNFpBJTJGMjAyNDA0MDIlMkZ1cy1lYXN0LTElMkZzMyUyRmF3czRfcmVxdWVzdCZYLUFtei1EYXRlPTIwMjQwNDAyVDExMDcxNVomWC1BbXotRXhwaXJlcz0zMDAmWC1BbXotU2lnbmF0dXJlPTU3MTBkZDQ2NDQwNjQ4MDIwYjQyYWVmMDMzODlmODUzY2Y0MWIwMTA2ZmMzOGEwZWI3MTBkZjc5NjhkMmNmNzEmWC1BbXotU2lnbmVkSGVhZGVycz1ob3N0JmFjdG9yX2lkPTAma2V5X2lkPTAmcmVwb19pZD0wIn0.MaUGQdwwbswq8ymZ1iVTuKm0ySCFhdW56leXA6jRMFI\" alt=\"image\" style=\"max-width: 100%;\"></a></li>\n<li>The index is built and stored in the memory, and the disk is flushed once every second, so there will be some index data (the white blocks) is not written to the disk.<br>\n<a target=\"_blank\" rel=\"noopener noreferrer\" href=\"https://private-user-images.githubusercontent.com/46882838/267643744-d1cdd010-eb85-4cd4-9f04-a9bc399f14ab.png?jwt=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJnaXRodWIuY29tIiwiYXVkIjoicmF3LmdpdGh1YnVzZXJjb250ZW50LmNvbSIsImtleSI6ImtleTUiLCJleHAiOjE3MTIwNTYzMzUsIm5iZiI6MTcxMjA1NjAzNSwicGF0aCI6Ii80Njg4MjgzOC8yNjc2NDM3NDQtZDFjZGQwMTAtZWI4NS00Y2Q0LTlmMDQtYTliYzM5OWYxNGFiLnBuZz9YLUFtei1BbGdvcml0aG09QVdTNC1ITUFDLVNIQTI1NiZYLUFtei1DcmVkZW50aWFsPUFLSUFWQ09EWUxTQTUzUFFLNFpBJTJGMjAyNDA0MDIlMkZ1cy1lYXN0LTElMkZzMyUyRmF3czRfcmVxdWVzdCZYLUFtei1EYXRlPTIwMjQwNDAyVDExMDcxNVomWC1BbXotRXhwaXJlcz0zMDAmWC1BbXotU2lnbmF0dXJlPWEzMzcxODU5MTkzMWNkODJlMDQ1NWY0YmJjZDgyZTQzMGNjZTZhNTIwNTVkYTNlZjBkZDY4MjJiZmY3ZjNmNjcmWC1BbXotU2lnbmVkSGVhZGVycz1ob3N0JmFjdG9yX2lkPTAma2V5X2lkPTAmcmVwb19pZD0wIn0.OTFo9602jjlhKLRDbJ6b-GCUv9LJItRHK26CBkPEHlU\"><img src=\"https://private-user-images.githubusercontent.com/46882838/267643744-d1cdd010-eb85-4cd4-9f04-a9bc399f14ab.png?jwt=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJnaXRodWIuY29tIiwiYXVkIjoicmF3LmdpdGh1YnVzZXJjb250ZW50LmNvbSIsImtleSI6ImtleTUiLCJleHAiOjE3MTIwNTYzMzUsIm5iZiI6MTcxMjA1NjAzNSwicGF0aCI6Ii80Njg4MjgzOC8yNjc2NDM3NDQtZDFjZGQwMTAtZWI4NS00Y2Q0LTlmMDQtYTliYzM5OWYxNGFiLnBuZz9YLUFtei1BbGdvcml0aG09QVdTNC1ITUFDLVNIQTI1NiZYLUFtei1DcmVkZW50aWFsPUFLSUFWQ09EWUxTQTUzUFFLNFpBJTJGMjAyNDA0MDIlMkZ1cy1lYXN0LTElMkZzMyUyRmF3czRfcmVxdWVzdCZYLUFtei1EYXRlPTIwMjQwNDAyVDExMDcxNVomWC1BbXotRXhwaXJlcz0zMDAmWC1BbXotU2lnbmF0dXJlPWEzMzcxODU5MTkzMWNkODJlMDQ1NWY0YmJjZDgyZTQzMGNjZTZhNTIwNTVkYTNlZjBkZDY4MjJiZmY3ZjNmNjcmWC1BbXotU2lnbmVkSGVhZGVycz1ob3N0JmFjdG9yX2lkPTAma2V5X2lkPTAmcmVwb19pZD0wIn0.OTFo9602jjlhKLRDbJ6b-GCUv9LJItRHK26CBkPEHlU\" alt=\"cq-destroy drawio\" style=\"max-width: 100%;\"></a></li>\n<li>A power outage on the host causes the loss of unpersisted consumeQueue records in the pagecache.<br>\n<a target=\"_blank\" rel=\"noopener noreferrer\" href=\"https://private-user-images.githubusercontent.com/46882838/267644465-18b1f92e-8821-4d72-a5f6-e10360383b5a.png?jwt=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJnaXRodWIuY29tIiwiYXVkIjoicmF3LmdpdGh1YnVzZXJjb250ZW50LmNvbSIsImtleSI6ImtleTUiLCJleHAiOjE3MTIwNTYzMzUsIm5iZiI6MTcxMjA1NjAzNSwicGF0aCI6Ii80Njg4MjgzOC8yNjc2NDQ0NjUtMThiMWY5MmUtODgyMS00ZDcyLWE1ZjYtZTEwMzYwMzgzYjVhLnBuZz9YLUFtei1BbGdvcml0aG09QVdTNC1ITUFDLVNIQTI1NiZYLUFtei1DcmVkZW50aWFsPUFLSUFWQ09EWUxTQTUzUFFLNFpBJTJGMjAyNDA0MDIlMkZ1cy1lYXN0LTElMkZzMyUyRmF3czRfcmVxdWVzdCZYLUFtei1EYXRlPTIwMjQwNDAyVDExMDcxNVomWC1BbXotRXhwaXJlcz0zMDAmWC1BbXotU2lnbmF0dXJlPWY1NTM2MGU2ZDViM2YwNmZjZDk3M2U3ZTY1M2Y4NmQ4MTlmYTY5MDk1M2I3MzFjMThhNDYzMWUwNDdlNThiYTcmWC1BbXotU2lnbmVkSGVhZGVycz1ob3N0JmFjdG9yX2lkPTAma2V5X2lkPTAmcmVwb19pZD0wIn0.lRRqLZ6cZc9AwjjXLi1BWx_G6d4F7-Oq98orHf3iVZs\"><img src=\"https://private-user-images.githubusercontent.com/46882838/267644465-18b1f92e-8821-4d72-a5f6-e10360383b5a.png?jwt=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJnaXRodWIuY29tIiwiYXVkIjoicmF3LmdpdGh1YnVzZXJjb250ZW50LmNvbSIsImtleSI6ImtleTUiLCJleHAiOjE3MTIwNTYzMzUsIm5iZiI6MTcxMjA1NjAzNSwicGF0aCI6Ii80Njg4MjgzOC8yNjc2NDQ0NjUtMThiMWY5MmUtODgyMS00ZDcyLWE1ZjYtZTEwMzYwMzgzYjVhLnBuZz9YLUFtei1BbGdvcml0aG09QVdTNC1ITUFDLVNIQTI1NiZYLUFtei1DcmVkZW50aWFsPUFLSUFWQ09EWUxTQTUzUFFLNFpBJTJGMjAyNDA0MDIlMkZ1cy1lYXN0LTElMkZzMyUyRmF3czRfcmVxdWVzdCZYLUFtei1EYXRlPTIwMjQwNDAyVDExMDcxNVomWC1BbXotRXhwaXJlcz0zMDAmWC1BbXotU2lnbmF0dXJlPWY1NTM2MGU2ZDViM2YwNmZjZDk3M2U3ZTY1M2Y4NmQ4MTlmYTY5MDk1M2I3MzFjMThhNDYzMWUwNDdlNThiYTcmWC1BbXotU2lnbmVkSGVhZGVycz1ob3N0JmFjdG9yX2lkPTAma2V5X2lkPTAmcmVwb19pZD0wIn0.lRRqLZ6cZc9AwjjXLi1BWx_G6d4F7-Oq98orHf3iVZs\" alt=\"cq-destroy drawio (1)\" style=\"max-width: 100%;\"></a></li>\n<li>After the Broker is started, the current maximum reputOffset is 1004. The index building starts from 1005, so 1002 and 1003 are skipped.<br>\n<a target=\"_blank\" rel=\"noopener noreferrer\" href=\"https://private-user-images.githubusercontent.com/46882838/267649958-f2918a97-d067-4630-a88b-a4fe04bf55d8.png?jwt=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJnaXRodWIuY29tIiwiYXVkIjoicmF3LmdpdGh1YnVzZXJjb250ZW50LmNvbSIsImtleSI6ImtleTUiLCJleHAiOjE3MTIwNTYzMzUsIm5iZiI6MTcxMjA1NjAzNSwicGF0aCI6Ii80Njg4MjgzOC8yNjc2NDk5NTgtZjI5MThhOTctZDA2Ny00NjMwLWE4OGItYTRmZTA0YmY1NWQ4LnBuZz9YLUFtei1BbGdvcml0aG09QVdTNC1ITUFDLVNIQTI1NiZYLUFtei1DcmVkZW50aWFsPUFLSUFWQ09EWUxTQTUzUFFLNFpBJTJGMjAyNDA0MDIlMkZ1cy1lYXN0LTElMkZzMyUyRmF3czRfcmVxdWVzdCZYLUFtei1EYXRlPTIwMjQwNDAyVDExMDcxNVomWC1BbXotRXhwaXJlcz0zMDAmWC1BbXotU2lnbmF0dXJlPTEyNjlhZTM1NTEzZWIyMjdiNzQxMWZmMDQzOGRmZDIzNmZhYTU0YTQ0MWIyMGExMWE1MzE3MzE4YmYxNDhiNDQmWC1BbXotU2lnbmVkSGVhZGVycz1ob3N0JmFjdG9yX2lkPTAma2V5X2lkPTAmcmVwb19pZD0wIn0.HiEUyKF8u26tbdUVY15k7HLBzU3lbJhTH3AvnOE9tn4\"><img src=\"https://private-user-images.githubusercontent.com/46882838/267649958-f2918a97-d067-4630-a88b-a4fe04bf55d8.png?jwt=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJnaXRodWIuY29tIiwiYXVkIjoicmF3LmdpdGh1YnVzZXJjb250ZW50LmNvbSIsImtleSI6ImtleTUiLCJleHAiOjE3MTIwNTYzMzUsIm5iZiI6MTcxMjA1NjAzNSwicGF0aCI6Ii80Njg4MjgzOC8yNjc2NDk5NTgtZjI5MThhOTctZDA2Ny00NjMwLWE4OGItYTRmZTA0YmY1NWQ4LnBuZz9YLUFtei1BbGdvcml0aG09QVdTNC1ITUFDLVNIQTI1NiZYLUFtei1DcmVkZW50aWFsPUFLSUFWQ09EWUxTQTUzUFFLNFpBJTJGMjAyNDA0MDIlMkZ1cy1lYXN0LTElMkZzMyUyRmF3czRfcmVxdWVzdCZYLUFtei1EYXRlPTIwMjQwNDAyVDExMDcxNVomWC1BbXotRXhwaXJlcz0zMDAmWC1BbXotU2lnbmF0dXJlPTEyNjlhZTM1NTEzZWIyMjdiNzQxMWZmMDQzOGRmZDIzNmZhYTU0YTQ0MWIyMGExMWE1MzE3MzE4YmYxNDhiNDQmWC1BbXotU2lnbmVkSGVhZGVycz1ob3N0JmFjdG9yX2lkPTAma2V5X2lkPTAmcmVwb19pZD0wIn0.HiEUyKF8u26tbdUVY15k7HLBzU3lbJhTH3AvnOE9tn4\" alt=\"cq-destroy drawio (2)\" style=\"max-width: 100%;\"></a></li>\n</ul>\n<h3 dir=\"auto\"># Verify</h3>\n<ul dir=\"auto\">\n<li>Read the wrong consumeQueue file,</li>\n</ul>\n<div class=\"snippet-clipboard-content notranslate position-relative overflow-auto\" data-snippet-clipboard-copy-content=\"last=287986464, new=287986511, file=/home/mi/bak_cq/hlth-center-data/1/00000000005754000000\nMessageExt [brokerName=null, queueId=1, storeSize=1914, queueOffset=287986464, sysFlag=0, bornTimestamp=1694089617516}]\nMessageExt [brokerName=null, queueId=1, storeSize=1218, queueOffset=287986511, sysFlag=0, bornTimestamp=1694089620422}]\"><pre class=\"notranslate\"><code class=\"notranslate\">last=287986464, new=287986511, file=/home/mi/bak_cq/hlth-center-data/1/00000000005754000000\nMessageExt [brokerName=null, queueId=1, storeSize=1914, queueOffset=287986464, sysFlag=0, bornTimestamp=1694089617516}]\nMessageExt [brokerName=null, queueId=1, storeSize=1218, queueOffset=287986511, sysFlag=0, bornTimestamp=1694089620422}]\n</code></pre></div>\n<ul dir=\"auto\">\n<li>There is a gap. Theoretically, the QueueOffset of the next message should be 287986465, but in fact it is 287986511, a difference of 46. The converted index file length is exactly 920 bytes, which is consistent with the log.</li>\n</ul>\n<h3 dir=\"auto\"># Hot to fix</h3>\n<h4 dir=\"auto\">1. Memory cache</h4>\n<ul dir=\"auto\">\n<li>Add a cache to maintains the flushed offset of each queeu: map <Topic#QueueId, commitLogOffsetPhy></li>\n<li>When exiting abnormally, enter the CQ recover logic and start scanning the commitLog for recovery based on the smallest persistent location recorded in the map.</li>\n</ul>\n<h4 dir=\"auto\">2. Scan partly commitLogs</h4>\n<ul dir=\"auto\">\n<li>Since cq will be flushed periodically, the most recent commitLog files will be affected.</li>\n<li>Find the corresponding CommitLog A according to the error log. Then push forward a certain amount of time (3 minutes), find the first CommitLog that exceeds 3 minutes, and then start building from this commitLog</li>\n</ul>\n<h3 dir=\"auto\"># Linked issue</h3>\n<p dir=\"auto\"><a class=\"issue-link js-issue-link\" data-error-text=\"Failed to load title\" data-id=\"482144475\" data-permission-text=\"Title is private\" data-url=\"https://github.com/apache/rocketmq/issues/1397\" data-hovercard-type=\"issue\" data-hovercard-url=\"/apache/rocketmq/issues/1397/hovercard\" href=\"https://github.com/apache/rocketmq/issues/1397\">#1397</a></p>",
  "description_text": "Before Creating the Bug Report\n\n\n I found a bug, not just asking a question, which should be created in GitHub Discussions.\n\n\n I have searched the GitHub Issues and GitHub Discussions  of this repository and believe that this is not a duplicate.\n\n\n I have confirmed that this bug belongs to the current repository, not other repositories of RocketMQ.\n\n\nRuntime platform environment\nOS: CentOS 7.3\nRocketMQ version\n4.8.x DLedger Model\nJDK Version\nopenjdk version \"1.8.0_202\"\nDescribe the Bug\n\nA downtime occurred on the slave node\nWhen the Broker process is started, the following exception log appears during building consumeQueue index.\n\n[BUG]logic queue order maybe wrong, expectLogicOffset: 5762122360 currentLogicOffset: 5762121440 Topic: hlth-center-data QID: 1 Diff: 920\n\n\nDelete all consumeQueues and back to normal.\n\nSteps to Reproduce\n\nstop the slave node.\ndelete the last consumeQueue of a queue.\nstart the slave node.\n\nWhat Did You Expect to See?\nThis log should not be printed.\nWhat Did You See Instead?\n[BUG]logic queue order maybe wrong, expectLogicOffset: 5762122360 currentLogicOffset: 5762121440 Topic: hlth-center-data QID: 1 Diff: 920\n\nAdditional Context\n# Possible reason\n\nA power outage on the host causes the loss of unpersisted consumeQueue records in the pagecache.\n\n# Process\n\nConsumeQueue files are flushed asynchronously, executed once every 1 second\n\nThe index is built and stored in the memory, and the disk is flushed once every second, so there will be some index data (the white blocks) is not written to the disk.\n\nA power outage on the host causes the loss of unpersisted consumeQueue records in the pagecache.\n\nAfter the Broker is started, the current maximum reputOffset is 1004. The index building starts from 1005, so 1002 and 1003 are skipped.\n\n\n# Verify\n\nRead the wrong consumeQueue file,\n\nlast=287986464, new=287986511, file=/home/mi/bak_cq/hlth-center-data/1/00000000005754000000\nMessageExt [brokerName=null, queueId=1, storeSize=1914, queueOffset=287986464, sysFlag=0, bornTimestamp=1694089617516}]\nMessageExt [brokerName=null, queueId=1, storeSize=1218, queueOffset=287986511, sysFlag=0, bornTimestamp=1694089620422}]\n\n\nThere is a gap. Theoretically, the QueueOffset of the next message should be 287986465, but in fact it is 287986511, a difference of 46. The converted index file length is exactly 920 bytes, which is consistent with the log.\n\n# Hot to fix\n1. Memory cache\n\nAdd a cache to maintains the flushed offset of each queeu: map \nWhen exiting abnormally, enter the CQ recover logic and start scanning the commitLog for recovery based on the smallest persistent location recorded in the map.\n\n2. Scan partly commitLogs\n\nSince cq will be flushed periodically, the most recent commitLog files will be affected.\nFind the corresponding CommitLog A according to the error log. Then push forward a certain amount of time (3 minutes), find the first CommitLog that exceeds 3 minutes, and then start building from this commitLog\n\n# Linked issue\n#1397"
}